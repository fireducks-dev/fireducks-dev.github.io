<!doctype html><html lang=ja-jp><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=preload as=font href=https://fireducks-dev.github.io/fonts/vendor/jost/jost-v4-latin-regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://fireducks-dev.github.io/fonts/vendor/jost/jost-v4-latin-500.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://fireducks-dev.github.io/fonts/vendor/jost/jost-v4-latin-700.woff2 type=font/woff2 crossorigin><script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script><link rel=stylesheet href=https://fireducks-dev.github.io/main.280962f974eb82354c447978a6574463448ea8c1d8e7874c8642a004f5713d4dba64daa30b7bc622b650b58c5de2666e72015e3d2cc02195358f9693469d5b94.css integrity="sha512-KAli+XTrgjVMRHl4pldEY0SOqMHY54dMhkKgBPVxPU26ZNqjC3vGIrZQtYxd4mZucgFePSzAIZU1j5aTRp1blA==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>Pythonの高速データフレームライブラリFireDucksを使ってみた - FireDucks</title><meta name=description content="FireDucks is a fast DataFrame python library with pandas-api"><link rel=canonical href=https://fireducks-dev.github.io/ja/posts/nes_taxi/><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="Pythonの高速データフレームライブラリFireDucksを使ってみた"><meta property="og:description" content="FireDucks is a fast DataFrame python library with pandas-api"><meta property="og:url" content="https://fireducks-dev.github.io/ja/posts/nes_taxi/"><meta property="og:site_name" content="FireDucks"><meta property="article:published_time" content="2023-10-23T08:47:36+00:00"><meta property="article:modified_time" content="2023-10-23T08:47:36+00:00"><meta property="og:image" content="https://fireducks-dev.github.io/fireducks.png"><meta property="og:image:alt" content="FireDucks"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@fireducksdev"><meta name=twitter:creator content="@fireducksdev"><meta name=twitter:title content="Pythonの高速データフレームライブラリFireDucksを使ってみた"><meta name=twitter:description content="FireDucks is a fast DataFrame python library with pandas-api"><meta name=twitter:image content="https://fireducks-dev.github.io/fireducks.png"><meta name=twitter:image:alt content="Pythonの高速データフレームライブラリFireDucksを使ってみた"><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"Organization","@id":"https://fireducks-dev.github.io/#/schema/organization/1","name":"FireDucks","url":"https://fireducks-dev.github.io/","sameAs":["https://twitter.com/fireducks","https://github.com/fireducks-dev"],"logo":{"@type":"ImageObject","@id":"https://fireducks-dev.github.io/#/schema/image/1","url":"https://fireducks-dev.github.io/fireducks.png","width":666,"height":298,"caption":"FireDucks"},"image":{"@id":"https://fireducks-dev.github.io/#/schema/image/1"}},{"@type":"WebSite","@id":"https://fireducks-dev.github.io/#/schema/website/1","url":"https://fireducks-dev.github.io/","name":"FireDucks","description":"FireDucks is a fast dataframe python library with pandas api","publisher":{"@id":"https://fireducks-dev.github.io/#/schema/organization/1"}},{"@type":"WebPage","@id":"https://fireducks-dev.github.io/ja/posts/nes_taxi/","url":"https://fireducks-dev.github.io/ja/posts/nes_taxi/","name":"Pythonの高速データフレームライブラリFireDucksを使ってみた","description":"FireDucks is a fast DataFrame python library with pandas-api","isPartOf":{"@id":"https://fireducks-dev.github.io/#/schema/website/1"},"about":{"@id":"https://fireducks-dev.github.io/#/schema/organization/1"},"datePublished":"2023-10-23T08:47:36CET","dateModified":"2023-10-23T08:47:36CET","breadcrumb":{"@id":"https://fireducks-dev.github.io/ja/posts/nes_taxi/#/schema/breadcrumb/1"},"primaryImageOfPage":{"@id":"https://fireducks-dev.github.io/ja/posts/nes_taxi/#/schema/image/2"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://fireducks-dev.github.io/ja/posts/nes_taxi/"]}]},{"@type":"BreadcrumbList","@id":"https://fireducks-dev.github.io/ja/posts/nes_taxi/#/schema/breadcrumb/1","name":"Breadcrumbs","itemListElement":[{"@type":"ListItem","position":1,"item":{"@type":"WebPage","@id":"https://fireducks-dev.github.io/","url":"https://fireducks-dev.github.io/","name":"Home"}},{"@type":"ListItem","position":2,"item":{"@type":"WebPage","@id":"https://fireducks-dev.github.io/ja/","url":"https://fireducks-dev.github.io/ja/","name":"Ja"}},{"@type":"ListItem","position":3,"item":{"@type":"WebPage","@id":"https://fireducks-dev.github.io/ja/posts/","url":"https://fireducks-dev.github.io/ja/posts/","name":"Posts"}},{"@type":"ListItem","position":4,"item":{"@id":"https://fireducks-dev.github.io/ja/posts/nes_taxi/"}}]},{"@context":"https://schema.org","@graph":[{"@type":"ImageObject","@id":"https://fireducks-dev.github.io/ja/posts/nes_taxi/#/schema/image/2","url":"https://fireducks-dev.github.io/fireducks.png","contentUrl":"https://fireducks-dev.github.io/fireducks.png","caption":"Pythonの高速データフレームライブラリFireDucksを使ってみた"}]}]}</script><meta name=theme-color content="#fff"><link rel=icon href=https://fireducks-dev.github.io/favicon.ico sizes=any><link rel=apple-touch-icon sizes=180x180 href=https://fireducks-dev.github.io/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://fireducks-dev.github.io/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://fireducks-dev.github.io/favicon-16x16.png><link rel=manifest crossorigin=use-credentials href=https://fireducks-dev.github.io/site.webmanifest><base href=https://fireducks-dev.github.io/></head><body class="posts single"><div class=sticky-top><div class=header-bar></div><header class="navbar navbar-expand-lg navbar-light doks-navbar"><nav class="container-xxl flex-wrap flex-lg-nowrap" aria-label="Main navigation"><a class="navbar-brand order-0" href=/ja/ aria-label=FireDucks>FireDucks</a>
<button class="btn btn-menu order-2 d-block d-lg-none" type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasDoks aria-controls=offcanvasDoks aria-label="Open main menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button><div class="offcanvas offcanvas-end border-0 py-lg-1" tabindex=-1 id=offcanvasDoks data-bs-backdrop=true aria-labelledby=offcanvasDoksLabel><div class="header-bar d-lg-none"></div><div class="offcanvas-header d-lg-none"><h2 class="h5 offcanvas-title ps-2" id=offcanvasDoksLabel><a class=text-dark href=/ja/>FireDucks</a></h2><button type=button class="btn-close text-reset me-2" data-bs-dismiss=offcanvas aria-label="Close main menu"></button></div><div class="offcanvas-body p-4 p-lg-0"><ul class="nav flex-column flex-lg-row align-items-lg-center mt-2 mt-lg-0 ms-lg-2 me-lg-auto"><li class=nav-item><a class="nav-link ps-0 py-1" href=/ja/docs/get-started/get-started/>Get Started</a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=/ja/docs/user-guide/01-intro/>Docs</a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=/ja/docs/benchmarks/benchmarks/>Benchmarks</a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=/ja/docs/about-us/about-us/>About Us</a></li></ul><hr class="text-black-50 my-4 d-lg-none"><form class="doks-search position-relative flex-grow-1 ms-lg-auto me-lg-2"><input id=search class="form-control is-search" type=search placeholder="Search docs..." aria-label="Search docs..." autocomplete=off><div id=suggestions class="shadow bg-white rounded d-none"></div></form><hr class="text-black-50 my-4 d-lg-none"><ul class="nav flex-column flex-lg-row"><li class=nav-item><a class="nav-link social-link" href=https://twitter.com/fireducksdev><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 1200 1227" fill="currentcolor" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-twitter"><path d="M714.163 519.284 1160.89.0H1055.03L667.137 450.887 357.328.0H0L468.492 681.821.0 1226.37H105.866L515.491 750.218 842.672 1226.37H12e2L714.137 519.284H714.163zM569.165 687.828l-47.468-67.894L144.011 79.6944H306.615L611.412 515.685l47.468 67.894 396.2 566.721H892.476L569.165 687.854V687.828z"/></svg><small class="ms-2 d-lg-none">Twitter</small></a></li></ul><hr class="text-black-50 my-4 d-lg-none"><button id=mode class="btn btn-link" type=button aria-label="Toggle user interface mode">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button><hr class="text-black-50 my-4 d-lg-none"><div class=dropdown><button class="btn btn-doks-light dropdown-toggle" id=doks-languages data-bs-toggle=dropdown aria-expanded=false data-bs-display=static>
Japanese
<span class=dropdown-caret><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"/></svg></span></button><ul class="dropdown-menu dropdown-menu-lg-end me-lg-2 shadow rounded border-0" aria-labelledby=doks-languages><li><a class="dropdown-item current" aria-current=true href=/ja/posts/nes_taxi/>Japanese</a></li><li><hr class=dropdown-divider></li><li><a class=dropdown-item rel=alternate href=/en/posts/nes_taxi/ hreflang=en lang=en>English</a></li></ul></div><a class="btn btn-primary mb-1" href=/ja/docs/get-started/get-started/#install>Try for Free</a></div></div></nav></header></div><div class="wrap container-xxl" role=document><div class=content><article><div class="row justify-content-center"><div class="col-md-12 col-lg-12"><div class=blog-header><h1>Pythonの高速データフレームライブラリFireDucksを使ってみた</h1><p><small>Posted&nbsp;on&nbsp;October 23, 2023 by
Yudai Morita</small></p></div></div><p><div class="col-md-12 col-lg-10 border border-primary border-2 mb-4">本記事は，<a href=https://www.nec-solutioninnovators.co.jp/>NECソリューションイノベータ株式会社</a>でデータ分析業務に携わる森田雄大様にFireDucksを試用していただき，執筆していただきました．</div></p><div class="col-md-12 col-lg-12"><p>pandasは，プログラミング言語Pythonにおいて，データ解析を支援する機能を提供するライブラリである．
NECの研究所では高速化版pandasであるFireDucksというライブラリを開発している．</p><h2 id=データの準備>データの準備 <a href=#%e3%83%87%e3%83%bc%e3%82%bf%e3%81%ae%e6%ba%96%e5%82%99 class=anchor aria-hidden=true>#</a></h2><p>ニューヨークのタクシーの乗降者履歴のデータを対象に分析を行う．
データの出典は以下である：</p><blockquote><p><a href=https://www.nyc.gov/site/tlc/about/tlc-trip-record-data.page>https://www.nyc.gov/site/tlc/about/tlc-trip-record-data.page</a></p></blockquote><p>大規模データの解析を行うため，上記リンクから「Yellow Taxi Trip Records」を2022年1月から2023年6月までのデータをダウンロードし結合した．
データはparquet形式で提供されているが，日頃良く使うcsv形式で試すために変換しておく．
参考までにデータ準備用のスクリプトを付記しておく．</p><pre><code class=language-python>import pandas as pd
import os

dir = &quot;xxx&quot;
df_list = []
for year in [2022, 2023]:
    for i in range(12):
        month = str(i+1).zfill(2)
        fn = f&quot;yellow_tripdata_{year}-{month}.parquet&quot;
        file = os.path.join(dir, fn)
        if not os.path.exists(file):
            continue
        df = pd.read_parquet(fn)
        df_list.append(df)

all_df = pd.concat(df_list)
all_df.to_csv(&quot;taxi_all.csv&quot;)
</code></pre><p>データの中身は以下のような値が入っている（列は一部抜粋）．</p><table><thead><tr><th>列名</th><th><nobr>データ型</nobr></th><th>説明</th></tr></thead><tbody><tr><td><code>passenger_count</code></td><td>int</td><td>乗車人数</td></tr><tr><td><code>pu_location_Id</code></td><td>string</td><td>タクシーメーターが作動し始めたTLCタクシーゾーン．</td></tr><tr><td><code>do_location_Id</code></td><td>string</td><td>タクシーメーターが解除されたTLCタクシーゾーン．</td></tr><tr><td><code>tpep_dropoff_datetime</code></td><td>string</td><td>メーターが解除された日時．</td></tr><tr><td><code>tpep_pickupdate_time</code></td><td>string</td><td>メーターが作動し始めた日時．</td></tr><tr><td><code>trip_distance</code></td><td>double</td><td>タクシーメーターによって報告された走行距離（マイル単位）．</td></tr><tr><td><code>total_amount</code></td><td>double</td><td>乗客に請求される合計金額． ※現金のチップは含まれない．</td></tr><tr><td><code>extra</code></td><td>double</td><td>その他の割増料金と追加料金．現在，これには0.50ドルおよび1ドルのラッシュアワー料金と夜間料金のみが含まれる．</td></tr><tr><td><code>fare_amount</code></td><td>double</td><td>メーターによって計算された時間距離併用運賃．</td></tr></tbody></table><h2 id=実際に行う前処理>実際に行う前処理 <a href=#%e5%ae%9f%e9%9a%9b%e3%81%ab%e8%a1%8c%e3%81%86%e5%89%8d%e5%87%a6%e7%90%86 class=anchor aria-hidden=true>#</a></h2><p>用意したデータに対して，データ分析でよく利用される型変換，列追加，異常値削除などの一連の前処理計算を行う．</p><p>まず速度計測用のラッパーを用意しておく．
<code>_evaluate()</code>については後述する．</p><pre><code class=language-python>from time import time
from functools import wraps

def timer(func):
    @wraps(func)
    def wp(*args, **kargs):
        t = time()
        ret = func(*args, **kargs)
        print(f&quot;{func.__name__} : {(time() - t):.5g} [sec]&quot;)
        return ret
    return wp

def evaluate(df):
    if hasattr(df, &quot;_evaluate&quot;):
        df._evaluate()
</code></pre><h3 id=データの読み込み>データの読み込み <a href=#%e3%83%87%e3%83%bc%e3%82%bf%e3%81%ae%e8%aa%ad%e3%81%bf%e8%be%bc%e3%81%bf class=anchor aria-hidden=true>#</a></h3><p>まずはデータを読み込む．
pandasをimportしてから<code>read_csv</code>で読み込む．
関数だけ定義しておいて，後で纏めて呼び出して計測する．</p><pre><code class=language-python>import pandas as pd
</code></pre><pre><code class=language-python>@timer
def file_read(fn, args={}):
    df = pd.read_csv(fn, **args)
    evaluate(df)
    print(df.shape)
    return df
</code></pre><h3 id=データ処理>データ処理 <a href=#%e3%83%87%e3%83%bc%e3%82%bf%e5%87%a6%e7%90%86 class=anchor aria-hidden=true>#</a></h3><p>欠損値があるデータを削除する．</p><pre><code class=language-python>@timer
def drop_na(df):
    df.dropna(how=&quot;all&quot;, inplace=True)
    evaluate(df)
    return df
</code></pre><p>乗車，降車の年月日時はstring型で読み込んだので，日付型に変換しておく．</p><pre><code class=language-python>@timer
def txt_to_date(df, low):
    df[low] = pd.to_datetime(df[low])
    evaluate(df)
    return df
</code></pre><p>乗車数でgroupbyして分布を見てみる（printは性能評価に含めないので省略）．
乗車数0人のデータがあることが分かるので，削除する．</p><pre><code class=language-python># 一人以上乗車している
@timer
def check_passenger_c(df):
    df_ = df.groupby(&quot;passenger_count&quot;).size()
    evaluate(df_)
    df = df[df[&quot;passenger_count&quot;] &gt; 0]
    evaluate(df)
    return df
</code></pre><p>乗車日時の日付データから，年，月，日，時の情報を取り出し，列を追加する．
乗車年や月の分布を見てみると不適切な値が含まれているので，削除する．</p><pre><code class=language-python># 乗車年/月が正しい
@timer
def check_pu_date(df):
    df['year'] =  df['tpep_pickup_datetime'].dt.year
    df['month'] = df['tpep_pickup_datetime'].dt.month
    df['date'] =  df['tpep_pickup_datetime'].dt.day
    df['hour'] =  df['tpep_pickup_datetime'].dt.hour

    df_ = df.groupby(&quot;year&quot;).size()
    evaluate(df_)
    df = df[(df['year'] == 2022) | (df['year'] == 2023)]

    df_ = df.groupby(&quot;month&quot;).size()
    evaluate(df_)
    df = df[(df['month'] &gt;= 1) &amp; df['month'] &lt;= 12]

    df_ = df.groupby([&quot;year&quot;, &quot;month&quot;]).size()
    evaluate(df_)
    evaluate(df)
    return df
</code></pre><p>降車時間と乗車時間の差を分に変換して列を追加する．
非正の乗車時間や長すぎる乗車時間を削除する．</p><pre><code class=language-python># 現実的な乗車時間（分）
@timer
def check_ride_time(df):
    df[&quot;ride_time&quot;] = (df[&quot;tpep_dropoff_datetime&quot;] - df[&quot;tpep_pickup_datetime&quot;]).dt.seconds / 60
    df = df[(df[&quot;ride_time&quot;] &gt; 0) &amp; (df[&quot;ride_time&quot;] &lt;= 180)]
    evaluate(df)
    return df
</code></pre><p>乗車距離や運賃についても非負や大きすぎる値を削除する．</p><pre><code class=language-python># 現実的な距離
@timer
def check_trip_distance(df):
    df = df[(df[&quot;trip_distance&quot;] &gt; 0) &amp; (df[&quot;trip_distance&quot;] &lt;= 250)]
    evaluate(df)
    return df

# 現実的な運賃
@timer
def check_total_amount(df):
    df = df[(df[&quot;total_amount&quot;] &gt; 0) &amp; (df[&quot;total_amount&quot;] &lt;= 1000)]
    evaluate(df)
    return df
</code></pre><p>乗降車地点のIDから緯度経度を算出する．
IDと地点の関係は以下で確認することができる．</p><blockquote><p><a href=https://d37ci6vzurychx.cloudfront.net/misc/taxi+_zone_lookup.csv>https://d37ci6vzurychx.cloudfront.net/misc/taxi+_zone_lookup.csv</a></p></blockquote><p>緯度経度は，</p><blockquote><p><a href=https://d37ci6vzurychx.cloudfront.net/misc/taxi_zones.zip>https://d37ci6vzurychx.cloudfront.net/misc/taxi_zones.zip</a></p></blockquote><p>をもとに作成した変換テーブルをmergeすることで列を追加する．</p><p>緯度経度の情報からニューヨーク市外のデータを削除する．</p><pre><code class=language-python># IDから緯度経度を割り出す
@timer
def add_coordinate(df, ID_df):
    df = df.merge(ID_df.rename(columns={&quot;longitude&quot;: &quot;start_lon&quot;, &quot;latitude&quot;: &quot;start_lat&quot;}),
                  left_on=&quot;PULocationID&quot;, right_on=&quot;LocationID&quot;, how=&quot;left&quot;).drop(&quot;LocationID&quot;, axis=1)
    df = df.merge(ID_df.rename(columns={&quot;longitude&quot;: &quot;end_lon&quot;, &quot;latitude&quot;: &quot;end_lat&quot;}),
                  left_on=&quot;DOLocationID&quot;, right_on=&quot;LocationID&quot;, how=&quot;left&quot;).drop(&quot;LocationID&quot;, axis=1)
    evaluate(df)
    return df

# NY内かをcheckする
@timer
def in_NY(df):
    df = df[(df[&quot;start_lon&quot;] &lt;= -71.47) &amp; (df[&quot;start_lon&quot;] &gt;= -79.45)]
    df = df[(df[&quot;start_lat&quot;] &gt;= 40.29) &amp; (df[&quot;start_lat&quot;] &lt;= 45)]
    df = df[(df[&quot;end_lon&quot;] &lt;= -71.47) &amp; (df[&quot;end_lon&quot;] &gt;= -79.45)]
    df = df[(df[&quot;end_lat&quot;] &gt;= 40.29) &amp; (df[&quot;end_lat&quot;] &lt;= 45)]
    evaluate(df)
    return df

def check_in_NY(df, ID_df):
    df = add_coordinate(df, ID_df)
    df = in_NY(df)
    return df
</code></pre><p>以上のようにデータを読み込み，型変換，列追加，異常値削除をする一連の処理を用意した．</p><ol><li>ファイルの読み込み</li><li>日付データを文字列から日付型に変換</li><li>前処理<ol><li>欠損値を削除</li><li>乗客数のチェック<ol><li>groupbyで分布を確認</li><li>1人以上を選択</li></ol></li><li>乗車時刻をチェック<ol><li>日付データから年月日時を取得し，列を追加</li><li>年でgroupbyして，確認 → 該当年のみを選択</li><li>月でgroupbyして，確認 → 1～12月のみを選択</li><li>年，月でgroupbyして分布を確認</li></ol></li><li>乗車時間をcheck<ol><li>降車時刻と乗車時刻の差をとり，分に変換して列を追加（<code>dt.total_second</code>がFireDucks未対応）</li><li>現実的な乗車時間のデータを選択する</li></ol></li><li>乗車距離をチェック<ol><li>現実的な乗車距離のデータを選択する</li></ol></li><li>料金をチェック<ol><li>現実的な料金のデータを選択する</li></ol></li><li>NY市内のデータを選択<ol><li>乗降車のIDと，緯度経度のテーブルをマージする</li><li>乗降車の緯度経度がNY市内となっているデータを選択</li></ol></li></ol></li></ol><h2 id=pandasでの実行時間>pandasでの実行時間 <a href=#pandas%e3%81%a7%e3%81%ae%e5%ae%9f%e8%a1%8c%e6%99%82%e9%96%93 class=anchor aria-hidden=true>#</a></h2><p>まずはpandasでの実行時間を確認してみる．
測定には24コアXeonサーバー（Intel(R) Xeon(R) Gold 6226 CPU x 2，メインメモリ256GB）を用いた．</p><pre><code class=language-python>import os
data_path = &quot;data_sets&quot;
fn = os.path.join(data_path, &quot;taxi_all.csv&quot;)
ID_file = os.path.join(data_path, &quot;ID_to_coordinate.csv&quot;)

need_cols = ['tpep_pickup_datetime','tpep_dropoff_datetime', 'passenger_count', 'trip_distance',
'PULocationID', 'DOLocationID', 'total_amount', 'improvement_surcharge', 'extra', 'fare_amount', 'RatecodeID']

@timer
def Preprocessing():
    df = file_read(fn, {&quot;usecols&quot;: need_cols})
    ID_df = file_read(ID_file)

    df = txt_to_date(df, &quot;tpep_pickup_datetime&quot;)
    df = txt_to_date(df, &quot;tpep_dropoff_datetime&quot;)

    df = drop_na(df)
    df = check_passenger_c(df)
    df = check_pu_date(df)
    df = check_ride_time(df)
    df = check_trip_distance(df)
    df = check_total_amount(df)
    df = check_in_NY(df, ID_df)
    evaluate(df)
    return df

df = Preprocessing()
</code></pre><p>さて，pandasでの実行時間は下表のような結果になった．
<code>file_read</code>が2件あるのはtaxiのデータの他に，マージ用の地点データも読み込んだためであり，<code>txt_to_date</code>は乗車時間と降車時間の2件を変換したためである．
実行時間を見てみるとファイル読み込みに1分以上かかっていることが分かる．
さらに列の追加やmerge処理を含む<code>check_pu_date</code>や<code>add_coordinate</code>に30秒以上時間がかかっており，実装した前処理の実行時間は終了するまでに186秒かかっている．</p><h2 id=fireducksでの実行時間>FireDucksでの実行時間 <a href=#fireducks%e3%81%a7%e3%81%ae%e5%ae%9f%e8%a1%8c%e6%99%82%e9%96%93 class=anchor aria-hidden=true>#</a></h2><p>importするライブラリをpandasに置き換えてFireDucksを用いた場合の実行時間の計測を行う．</p><pre><code class=language-shell>pip install fireducks
</code></pre><p>pandasの前処理計算のために記述した上記スクリプトはFireDucksがpandasとの互換性を持っているためにFireDucksをimportすれば，そのまま利用可能である．</p><pre><code class=language-python>import fireducks.pandas as pd
</code></pre><p>注意点として，FireDucksはメソッドが呼ばれても処理をすぐには実行せず，結果が必要になった際にまとめて処理を実行する．
そのため，各メソッドの実行時間を計測するためには<code>_evaliate()</code>を実行する必要がある．</p><p>FireDucksをimportし，同様の前処理計算を実行するとpandasとの実行時間との比較の表は以下のようになった．</p><table><thead><tr><th style=text-align:left>関数</th><th style=text-align:right>pandas[sec]</th><th style=text-align:right>FireDucks[sec]</th><th style=text-align:right>速度向上率</th></tr></thead><tbody><tr><td style=text-align:left><code>file_read</code></td><td style=text-align:right>72.19</td><td style=text-align:right>3.52</td><td style=text-align:right>20.49</td></tr><tr><td style=text-align:left><code>file_read</code></td><td style=text-align:right>0.003</td><td style=text-align:right>0.01</td><td style=text-align:right>0.38</td></tr><tr><td style=text-align:left><code>txt_to_date</code></td><td style=text-align:right>9.07</td><td style=text-align:right>19.10</td><td style=text-align:right>0.48</td></tr><tr><td style=text-align:left><code>txt_to_date</code></td><td style=text-align:right>8.57</td><td style=text-align:right>20.57</td><td style=text-align:right>0.42</td></tr><tr><td style=text-align:left><code>drop_na</code></td><td style=text-align:right>3.13</td><td style=text-align:right>0.70</td><td style=text-align:right>4.47</td></tr><tr><td style=text-align:left><code>check_passenger_c</code></td><td style=text-align:right>3.21</td><td style=text-align:right>1.80</td><td style=text-align:right>1.79</td></tr><tr><td style=text-align:left><code>check_pu_date</code></td><td style=text-align:right>27.37</td><td style=text-align:right>0.99</td><td style=text-align:right>27.64</td></tr><tr><td style=text-align:left><code>check_ride_time</code></td><td style=text-align:right>7.02</td><td style=text-align:right>2.00</td><td style=text-align:right>3.51</td></tr><tr><td style=text-align:left><code>check_trip_distance</code></td><td style=text-align:right>3.24</td><td style=text-align:right>0.91</td><td style=text-align:right>3.55</td></tr><tr><td style=text-align:left><code>check_total_amount</code></td><td style=text-align:right>3.11</td><td style=text-align:right>0.93</td><td style=text-align:right>3.59</td></tr><tr><td style=text-align:left><code>add_coordinate</code></td><td style=text-align:right>28.32</td><td style=text-align:right>1.67</td><td style=text-align:right>16.97</td></tr><tr><td style=text-align:left><code>in_NY</code></td><td style=text-align:right>20.75</td><td style=text-align:right>2.71</td><td style=text-align:right>7.65</td></tr><tr><td style=text-align:left><code>Preprocessing</code></td><td style=text-align:right>186.02</td><td style=text-align:right>54.92</td><td style=text-align:right>3.39</td></tr></tbody></table><p><code>file_read</code>についてpandasでは終了まで70秒以上かかっていたが約3.5秒となり20倍以上高速化ができていることが確認できた．
またその他の時間がかかっていた処理（<code>check_pu_date</code>，<code>add_coordinate</code>）についても大幅な時間短縮ができている．</p><p><code>txt_to_date</code>についてはFireDucksを用いることで計算時間が増えている．
これは記事執筆時点において<code>to_datetime()</code>関数はFireDucksによる高速化対応がされていないためである．
しかし，<code>to_datetime()</code>のように高速化未対応な関数を呼ばれたときであってもFireDucksはpandasの関数を呼び出すことで計算を行うためエラーを返すことはない．</p><p>本記事の前処理計算においてトータルの計算時間はpandasが186秒であったのに対し，FireDucksでは55秒で約3.4倍の実行速度であった．
さらにこの55秒のうち40秒程は高速化未対応の処理に要する時間であり，今後更なる高速化が見込まれる．</p></div></div></article></div></div><footer class="footer text-muted"><div class=container-xxl><div class=row><div class="col-lg-8 order-last order-lg-first"><ul class=list-inline><li class=list-inline-item>Powered by <a class=text-muted href=https://gohugo.io/>Hugo</a> and <a class=text-muted href=https://getdoks.org/>Doks</a></li></ul></div><div class="col-lg-8 order-first order-lg-last text-lg-end"><ul class=list-inline></ul></div></div></div></footer><script src=/js/bootstrap.min.7315382e899a7d7132d93fdf0d6682c67a93f0e72ee1a757f33f3207de3b14e2460a935c9d4cec78f86d94ab892d053c70540695eed0bbb7bf5bdc979e6f5a9f.js integrity="sha512-cxU4LomafXEy2T/fDWaCxnqT8Ocu4adX8z8yB947FOJGCpNcnUzsePhtlKuJLQU8cFQGle7Qu7e/W9yXnm9anw==" crossorigin=anonymous defer></script>
<script src=/js/highlight.min.8b2d7ddd72ba2c88d5107387eb3b66b90f1f864fd5afef6aed284425efb5919a9bc092f653f2985a205b85b0a158f70b460643ba2b71ccf7d3c1c107c3a4b609.js integrity="sha512-iy193XK6LIjVEHOH6ztmuQ8fhk/Vr+9q7ShEJe+1kZqbwJL2U/KYWiBbhbChWPcLRgZDuitxzPfTwcEHw6S2CQ==" crossorigin=anonymous defer></script>
<script src=/main.min.57d9a84956f7d60008c47938c7fdd2f75e8618ff1d09c5a5e2b32f91debaf7681f7ceca8b51aded60067c2136172134a91ebc0674487c76a04e3244d927ebdde.js integrity="sha512-V9moSVb31gAIxHk4x/3S916GGP8dCcWl4rMvkd6692gffOyotRre1gBnwhNhchNKkevAZ0SHx2oE4yRNkn693g==" crossorigin=anonymous defer></script>
<script src=https://fireducks-dev.github.io/index.min.38a6290d203b724c6f4b1740aab33f498e7f1828f26910bc8bc593f6efd4f87029945fd98c969be574fbd32c9213359951eba12e4c69d574ae26f41ad1537bcb.js integrity="sha512-OKYpDSA7ckxvSxdAqrM/SY5/GCjyaRC8i8WT9u/U+HAplF/ZjJab5XT70yySEzWZUeuhLkxp1XSuJvQa0VN7yw==" crossorigin=anonymous defer></script></body></html>