<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=ja class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Pythonの高速データフレームライブラリFireDucksを使ってみた | FireDucks</title>
<meta name=description content="pandasは，プログラミング言語Pythonにおいて，データ解析を支援する機能を提供するライブラリである． NECの研究所では高速化版pandasであるFireDucksというライブラリを開発している．
データの準備 ニューヨークのタクシーの乗降者履歴のデータを対象に分析を行う． データの出典は以下である：
https://www.nyc.gov/site/tlc/about/tlc-trip-record-data.page
大規模データの解析を行うため，上記リンクから「Yellow Taxi Trip Records」を2022年1月から2023年6月までのデータをダウンロードし結合した． データはparquet形式で提供されているが，日頃良く使うcsv形式で試すために変換しておく． 参考までにデータ準備用のスクリプトを付記しておく．
import pandas as pd import os dir = &amp;#34;xxx&amp;#34; df_list = [] for year in [2022, 2023]: for i in range(12): month = str(i+1).zfill(2) fn = f&amp;#34;yellow_tripdata_{year}-{month}.parquet&amp;#34; file = os.path.join(dir, fn) if not os.path.exists(file): continue df = pd.read_parquet(fn) df_list.append(df) all_df = pd.concat(df_list) all_df.to_csv(&amp;#34;taxi_all.csv&amp;#34;) データの中身は以下のような値が入っている（列は一部抜粋）．
列名 データ型 説明 passenger_count int 乗車人数 pu_location_Id string タクシーメーターが作動し始めたTLCタクシーゾーン． do_location_Id string タクシーメーターが解除されたTLCタクシーゾーン． tpep_dropoff_datetime string メーターが解除された日時． tpep_pickupdate_time string メーターが作動し始めた日時． trip_distance double タクシーメーターによって報告された走行距離（マイル単位）． total_amount double 乗客に請求される合計金額． ※現金のチップは含まれない． extra double その他の割増料金と追加料金．現在，これには0."><meta property="og:title" content="Pythonの高速データフレームライブラリFireDucksを使ってみた"><meta property="og:description" content="pandasは，プログラミング言語Pythonにおいて，データ解析を支援する機能を提供するライブラリである． NECの研究所では高速化版pandasであるFireDucksというライブラリを開発している．
データの準備 ニューヨークのタクシーの乗降者履歴のデータを対象に分析を行う． データの出典は以下である：
https://www.nyc.gov/site/tlc/about/tlc-trip-record-data.page
大規模データの解析を行うため，上記リンクから「Yellow Taxi Trip Records」を2022年1月から2023年6月までのデータをダウンロードし結合した． データはparquet形式で提供されているが，日頃良く使うcsv形式で試すために変換しておく． 参考までにデータ準備用のスクリプトを付記しておく．
import pandas as pd import os dir = &#34;xxx&#34; df_list = [] for year in [2022, 2023]: for i in range(12): month = str(i+1).zfill(2) fn = f&#34;yellow_tripdata_{year}-{month}.parquet&#34; file = os.path.join(dir, fn) if not os.path.exists(file): continue df = pd.read_parquet(fn) df_list.append(df) all_df = pd.concat(df_list) all_df.to_csv(&#34;taxi_all.csv&#34;) データの中身は以下のような値が入っている（列は一部抜粋）．
列名 データ型 説明 passenger_count int 乗車人数 pu_location_Id string タクシーメーターが作動し始めたTLCタクシーゾーン． do_location_Id string タクシーメーターが解除されたTLCタクシーゾーン． tpep_dropoff_datetime string メーターが解除された日時． tpep_pickupdate_time string メーターが作動し始めた日時． trip_distance double タクシーメーターによって報告された走行距離（マイル単位）． total_amount double 乗客に請求される合計金額． ※現金のチップは含まれない． extra double その他の割増料金と追加料金．現在，これには0."><meta property="og:type" content="article"><meta property="og:url" content="https://fireducks-dev.github.io/ja/posts/nes_taxi/"><meta property="og:image" content="https://fireducks-dev.github.io/ja/posts/nes_taxi/G-1085892316.webp"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-10-23T08:47:36+00:00"><meta property="article:modified_time" content="2023-10-23T08:47:36+00:00"><meta itemprop=name content="Pythonの高速データフレームライブラリFireDucksを使ってみた"><meta itemprop=description content="pandasは，プログラミング言語Pythonにおいて，データ解析を支援する機能を提供するライブラリである． NECの研究所では高速化版pandasであるFireDucksというライブラリを開発している．
データの準備 ニューヨークのタクシーの乗降者履歴のデータを対象に分析を行う． データの出典は以下である：
https://www.nyc.gov/site/tlc/about/tlc-trip-record-data.page
大規模データの解析を行うため，上記リンクから「Yellow Taxi Trip Records」を2022年1月から2023年6月までのデータをダウンロードし結合した． データはparquet形式で提供されているが，日頃良く使うcsv形式で試すために変換しておく． 参考までにデータ準備用のスクリプトを付記しておく．
import pandas as pd import os dir = &#34;xxx&#34; df_list = [] for year in [2022, 2023]: for i in range(12): month = str(i+1).zfill(2) fn = f&#34;yellow_tripdata_{year}-{month}.parquet&#34; file = os.path.join(dir, fn) if not os.path.exists(file): continue df = pd.read_parquet(fn) df_list.append(df) all_df = pd.concat(df_list) all_df.to_csv(&#34;taxi_all.csv&#34;) データの中身は以下のような値が入っている（列は一部抜粋）．
列名 データ型 説明 passenger_count int 乗車人数 pu_location_Id string タクシーメーターが作動し始めたTLCタクシーゾーン． do_location_Id string タクシーメーターが解除されたTLCタクシーゾーン． tpep_dropoff_datetime string メーターが解除された日時． tpep_pickupdate_time string メーターが作動し始めた日時． trip_distance double タクシーメーターによって報告された走行距離（マイル単位）． total_amount double 乗客に請求される合計金額． ※現金のチップは含まれない． extra double その他の割増料金と追加料金．現在，これには0."><meta itemprop=datePublished content="2023-10-23T08:47:36+00:00"><meta itemprop=dateModified content="2023-10-23T08:47:36+00:00"><meta itemprop=wordCount content="582"><meta itemprop=image content="https://fireducks-dev.github.io/ja/posts/nes_taxi/G-1085892316.webp"><meta itemprop=keywords content><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://fireducks-dev.github.io/ja/posts/nes_taxi/G-1085892316.webp"><meta name=twitter:title content="Pythonの高速データフレームライブラリFireDucksを使ってみた"><meta name=twitter:description content="pandasは，プログラミング言語Pythonにおいて，データ解析を支援する機能を提供するライブラリである． NECの研究所では高速化版pandasであるFireDucksというライブラリを開発している．
データの準備 ニューヨークのタクシーの乗降者履歴のデータを対象に分析を行う． データの出典は以下である：
https://www.nyc.gov/site/tlc/about/tlc-trip-record-data.page
大規模データの解析を行うため，上記リンクから「Yellow Taxi Trip Records」を2022年1月から2023年6月までのデータをダウンロードし結合した． データはparquet形式で提供されているが，日頃良く使うcsv形式で試すために変換しておく． 参考までにデータ準備用のスクリプトを付記しておく．
import pandas as pd import os dir = &#34;xxx&#34; df_list = [] for year in [2022, 2023]: for i in range(12): month = str(i+1).zfill(2) fn = f&#34;yellow_tripdata_{year}-{month}.parquet&#34; file = os.path.join(dir, fn) if not os.path.exists(file): continue df = pd.read_parquet(fn) df_list.append(df) all_df = pd.concat(df_list) all_df.to_csv(&#34;taxi_all.csv&#34;) データの中身は以下のような値が入っている（列は一部抜粋）．
列名 データ型 説明 passenger_count int 乗車人数 pu_location_Id string タクシーメーターが作動し始めたTLCタクシーゾーン． do_location_Id string タクシーメーターが解除されたTLCタクシーゾーン． tpep_dropoff_datetime string メーターが解除された日時． tpep_pickupdate_time string メーターが作動し始めた日時． trip_distance double タクシーメーターによって報告された走行距離（マイル単位）． total_amount double 乗客に請求される合計金額． ※現金のチップは含まれない． extra double その他の割増料金と追加料金．現在，これには0."><link rel=preload href=/scss/main.min.2404b01c5fb65f0b4d76f0c632723d405f2faf20557f5aeff94d8efb2e91ec8b.css as=style><link href=/scss/main.min.2404b01c5fb65f0b4d76f0c632723d405f2faf20557f5aeff94d8efb2e91ec8b.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.3.min.js integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ==" crossorigin=anonymous></script></head><body class="td-page td-blog"><header><nav class="td-navbar navbar-dark js-navbar-scroll"><div class="container-fluid flex-column flex-md-row"><a class=navbar-brand href=/ja/><span class="navbar-brand__logo navbar-logo"></span><span class=navbar-brand__name>FireDucks</span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/ja/docs/get-started><span>Get Started</span></a></li><li class=nav-item><a class=nav-link href=/ja/docs/user-guide/01-intro/><span>Docs</span></a></li><li class=nav-item><a class=nav-link href=/ja/posts><span>Blogs</span></a></li><li class=nav-item><a class=nav-link href=/ja/docs/benchmarks><span>Benchmarks</span></a></li><li class=nav-item><a class=nav-link href=https://github.com/fireducks-dev/fireducks/issues target=_blank rel=noopener><span>Report Issue</span></a></li><li class=nav-item><a class=nav-link href=/ja/docs/about-us><span>About Us</span></a></li><li class="nav-item dropdown d-none d-lg-block"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>Japanese</a><ul class=dropdown-menu><li><a class=dropdown-item href=/posts/nes_taxi/>English</a></li></ul></div></li></ul></div><div class="d-none d-lg-block"></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ms-3 fas fa-bars" type=button data-bs-toggle=collapse data-bs-target=#td-section-nav aria-controls=td-section-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="td-sidebar-nav collapse" id=td-section-nav><div class="td-sidebar-nav__section nav-item dropdown d-block d-lg-none"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>Japanese</a><ul class=dropdown-menu><li><a class=dropdown-item href=/posts/nes_taxi/>English</a></li></ul></div></div><ul class="td-sidebar-nav__section pe-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-japosts-li><a href=/ja/posts/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-japosts><span>Posts</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japosts2024-05-27-note10-li><a href=https://note.com/fireducks/n/n9d169e9054ed target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-japosts2024-05-27-note10><i class="fa fa-external-link"></i><span>pandasを用いた大規模データの前処理をfireducksに置き換えてみる</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japosts2024-05-20-note09-li><a href=https://note.com/fireducks/n/necfbb2dfdb84 target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-japosts2024-05-20-note09><i class="fa fa-external-link"></i><span>生成AIとデータフレーム高速化技術を組み合わせたら、データ分析が爆楽になった話</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japosts2024-05-13-note08-li><a href=https://note.com/fireducks/n/n4dd370647766 target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-japosts2024-05-13-note08><i class="fa fa-external-link"></i><span>Pandasを高速化方法比較</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japosts2024-05-08-note07-li><a href=https://note.com/fireducks/n/na95cf890f13b target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-japosts2024-05-08-note07><i class="fa fa-external-link"></i><span>どれくらいスピードアップしたのか</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japosts2024-04-22-note06-li><a href=https://note.com/fireducks/n/nd79ee805d99a target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-japosts2024-04-22-note06><i class="fa fa-external-link"></i><span>FireDucks と Polarsを比較してみた</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japosts2024-04-15-note05-li><a href=https://note.com/fireducks/n/na7484ce210f0 target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-japosts2024-04-15-note05><i class="fa fa-external-link"></i><span>FireDucks性能評価</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japosts2024-04-09-note04-li><a href=https://note.com/fireducks/n/n604974763502 target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-japosts2024-04-09-note04><i class="fa fa-external-link"></i><span>pandasの代替案: Fireducks,Vaex, Polars, Modinを徹底比較！どれが最適？</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japosts2024-04-01-note03-li><a href=https://note.com/fireducks/n/na5fde86c0ba3 target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-japosts2024-04-01-note03><i class="fa fa-external-link"></i><span>AWS GlueでFireDucksを使ってPandasを高速化する</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japosts2024-03-22-note02-li><a href=https://note.com/fireducks/n/nb5cabbe9236e target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-japosts2024-03-22-note02><i class="fa fa-external-link"></i><span>FireDucks入門: 学習コストゼロでpandasを超えるパフォーマンスを手に入れる!</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japosts2024-03-15-note-li><a href=https://note.com/fireducks/n/nee73e753df26 target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-japosts2024-03-15-note><i class="fa fa-external-link"></i><span>pandas高速化の新星、FireDucksに迫る</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japosts2023-12-24-ishizaka-li><a href=https://qiita.com/iszk1215/items/4916799360bfafd57bc4 target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-japosts2023-12-24-ishizaka><i class="fa fa-external-link"></i><span>FireDucks vs Polars 42勝24敗！ あなたはどっちを使ってpandasを高速化する！？</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japosts2023-12-20-daido-li><a href=https://qiita.com/shu_ohm1/items/33642646f5c055066cfe target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-japosts2023-12-20-daido><i class="fa fa-external-link"></i><span>FireDucks に隠し機能を作ろうと思ったけどボツになった話</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japosts2023-12-18-araki-li><a href=https://qiita.com/takuya-araki/items/38c3554ba72c9eb274ba target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-japosts2023-12-18-araki><i class="fa fa-external-link"></i><span>FireDucksにおける最適化処理の紹介</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japosts2023-12-15-ishizaka-li><a href=https://qiita.com/iszk1215/items/2c6385fa575de378a619 target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-japosts2023-12-15-ishizaka><i class="fa fa-external-link"></i><span>FireDucksを支える技術</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japosts2023-12-08-ohno-li><a href=https://qiita.com/ysyk-ohno/items/ddaaeca630d741a78f14 target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-japosts2023-12-08-ohno><i class="fa fa-external-link"></i><span>FireDucks の GroupBy アルゴリズム切替えについての解説</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japostsest-li><a href=/ja/posts/est/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-japostsest><span>FireDucks内部で働く高速化技術</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japosts2023-12-04-ishizaka-li><a href=https://qiita.com/iszk1215/items/abe7621d9f6754de690a target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-japosts2023-12-04-ishizaka><i class="fa fa-external-link"></i><span>FireDucksのご紹介</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japosts2023-12-01-daido-li><a href=https://qiita.com/shu_ohm1/items/b0a35cfb4fce5b71c715 target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-japosts2023-12-01-daido><i class="fa fa-external-link"></i><span>FireDucks のインポートフック機能にまつわるエトセトラ</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japostsimporthook-li><a href=/ja/posts/importhook/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-japostsimporthook><span>インポートフック：ソースコードを書き換えずに FireDucks を使う方法のご紹介</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-japostsnes_taxi-li><a href=/ja/posts/nes_taxi/ class="align-left ps-0 active td-sidebar-link td-sidebar-link__page" id=m-japostsnes_taxi><span class=td-sidebar-nav-active-item>Pythonの高速データフレームライブラリFireDucksを使ってみた</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japoststtdc-li><a href=https://jpn.nec.com/rd/technologies/202312/index.html target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-japoststtdc><i class="fa fa-external-link"></i><span>導入事例：トヨタテクニカルディベロップメント株式会社様 「Spicy MINT」</span></a></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ms-2 pb-1 pt-2 mb-0"></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#データの準備>データの準備</a></li><li><a href=#実際に行う前処理>実際に行う前処理</a><ul><li><a href=#データの読み込み>データの読み込み</a></li><li><a href=#データ処理>データ処理</a></li></ul></li><li><a href=#pandasでの実行時間>pandasでの実行時間</a></li><li><a href=#fireducksでの実行時間>FireDucksでの実行時間</a></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 ps-md-5 pe-md-4" role=main><a class=td-rss-button title=RSS href=https://fireducks-dev.github.io/ja/posts/index.xml target=_blank rel=noopener><i class="fa-solid fa-rss" aria-hidden=true></i></a><div class=td-content><h1>Pythonの高速データフレームライブラリFireDucksを使ってみた</h1><div class="td-byline mb-4"><time datetime=2023-10-23 class=text-muted>Monday, October 23, 2023</time></div><header class=article-meta></header><p>pandasは，プログラミング言語Pythonにおいて，データ解析を支援する機能を提供するライブラリである．
NECの研究所では高速化版pandasであるFireDucksというライブラリを開発している．</p><h2 id=データの準備>データの準備</h2><p>ニューヨークのタクシーの乗降者履歴のデータを対象に分析を行う．
データの出典は以下である：</p><blockquote><p><a href=https://www.nyc.gov/site/tlc/about/tlc-trip-record-data.page>https://www.nyc.gov/site/tlc/about/tlc-trip-record-data.page</a></p></blockquote><p>大規模データの解析を行うため，上記リンクから「Yellow Taxi Trip Records」を2022年1月から2023年6月までのデータをダウンロードし結合した．
データはparquet形式で提供されているが，日頃良く使うcsv形式で試すために変換しておく．
参考までにデータ準備用のスクリプトを付記しておく．</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> pandas <span style=color:#66d9ef>as</span> pd
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>dir <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;xxx&#34;</span>
</span></span><span style=display:flex><span>df_list <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> year <span style=color:#f92672>in</span> [<span style=color:#ae81ff>2022</span>, <span style=color:#ae81ff>2023</span>]:
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>12</span>):
</span></span><span style=display:flex><span>month <span style=color:#f92672>=</span> str(i<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>)<span style=color:#f92672>.</span>zfill(<span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>fn <span style=color:#f92672>=</span> <span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;yellow_tripdata_</span><span style=color:#e6db74>{</span>year<span style=color:#e6db74>}</span><span style=color:#e6db74>-</span><span style=color:#e6db74>{</span>month<span style=color:#e6db74>}</span><span style=color:#e6db74>.parquet&#34;</span>
</span></span><span style=display:flex><span>file <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(dir, fn)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>exists(file):
</span></span><span style=display:flex><span><span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>df <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>read_parquet(fn)
</span></span><span style=display:flex><span>df_list<span style=color:#f92672>.</span>append(df)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>all_df <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>concat(df_list)
</span></span><span style=display:flex><span>all_df<span style=color:#f92672>.</span>to_csv(<span style=color:#e6db74>&#34;taxi_all.csv&#34;</span>)
</span></span></code></pre></div><p>データの中身は以下のような値が入っている（列は一部抜粋）．</p><table><thead><tr><th>列名</th><th>データ型</th><th>説明</th></tr></thead><tbody><tr><td><code>passenger_count</code></td><td>int</td><td>乗車人数</td></tr><tr><td><code>pu_location_Id</code></td><td>string</td><td>タクシーメーターが作動し始めたTLCタクシーゾーン．</td></tr><tr><td><code>do_location_Id</code></td><td>string</td><td>タクシーメーターが解除されたTLCタクシーゾーン．</td></tr><tr><td><code>tpep_dropoff_datetime</code></td><td>string</td><td>メーターが解除された日時．</td></tr><tr><td><code>tpep_pickupdate_time</code></td><td>string</td><td>メーターが作動し始めた日時．</td></tr><tr><td><code>trip_distance</code></td><td>double</td><td>タクシーメーターによって報告された走行距離（マイル単位）．</td></tr><tr><td><code>total_amount</code></td><td>double</td><td>乗客に請求される合計金額． ※現金のチップは含まれない．</td></tr><tr><td><code>extra</code></td><td>double</td><td>その他の割増料金と追加料金．現在，これには0.50ドルおよび1ドルのラッシュアワー料金と夜間料金のみが含まれる．</td></tr><tr><td><code>fare_amount</code></td><td>double</td><td>メーターによって計算された時間距離併用運賃．</td></tr></tbody></table><h2 id=実際に行う前処理>実際に行う前処理</h2><p>用意したデータに対して，データ分析でよく利用される型変換，列追加，異常値削除などの一連の前処理計算を行う．</p><p>まず速度計測用のラッパーを用意しておく．
<code>_evaluate()</code>については後述する．</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> time <span style=color:#f92672>import</span> time
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> functools <span style=color:#f92672>import</span> wraps
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>timer</span>(func):
</span></span><span style=display:flex><span><span style=color:#a6e22e>@wraps</span>(func)
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>wp</span>(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kargs):
</span></span><span style=display:flex><span>t <span style=color:#f92672>=</span> time()
</span></span><span style=display:flex><span>ret <span style=color:#f92672>=</span> func(<span style=color:#f92672>*</span>args, <span style=color:#f92672>**</span>kargs)
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>{</span>func<span style=color:#f92672>.</span>__name__<span style=color:#e6db74>}</span><span style=color:#e6db74> : </span><span style=color:#e6db74>{</span>(time() <span style=color:#f92672>-</span> t)<span style=color:#e6db74>:</span><span style=color:#e6db74>.5g</span><span style=color:#e6db74>}</span><span style=color:#e6db74> [sec]&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>return</span> ret
</span></span><span style=display:flex><span><span style=color:#66d9ef>return</span> wp
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>evaluate</span>(df):
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> hasattr(df, <span style=color:#e6db74>&#34;_evaluate&#34;</span>):
</span></span><span style=display:flex><span>df<span style=color:#f92672>.</span>_evaluate()
</span></span></code></pre></div><h3 id=データの読み込み>データの読み込み</h3><p>まずはデータを読み込む．
pandasをimportしてから<code>read_csv</code>で読み込む．
関数だけ定義しておいて，後で纏めて呼び出して計測する．</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> pandas <span style=color:#66d9ef>as</span> pd
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@timer</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>file_read</span>(fn, args<span style=color:#f92672>=</span>{}):
</span></span><span style=display:flex><span>df <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>read_csv(fn, <span style=color:#f92672>**</span>args)
</span></span><span style=display:flex><span>evaluate(df)
</span></span><span style=display:flex><span>print(df<span style=color:#f92672>.</span>shape)
</span></span><span style=display:flex><span><span style=color:#66d9ef>return</span> df
</span></span></code></pre></div><h3 id=データ処理>データ処理</h3><p>欠損値があるデータを削除する．</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@timer</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>drop_na</span>(df):
</span></span><span style=display:flex><span>df<span style=color:#f92672>.</span>dropna(how<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;all&#34;</span>, inplace<span style=color:#f92672>=</span><span style=color:#66d9ef>True</span>)
</span></span><span style=display:flex><span>evaluate(df)
</span></span><span style=display:flex><span><span style=color:#66d9ef>return</span> df
</span></span></code></pre></div><p>乗車，降車の年月日時はstring型で読み込んだので，日付型に変換しておく．</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@timer</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>txt_to_date</span>(df, low):
</span></span><span style=display:flex><span>df[low] <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>to_datetime(df[low])
</span></span><span style=display:flex><span>evaluate(df)
</span></span><span style=display:flex><span><span style=color:#66d9ef>return</span> df
</span></span></code></pre></div><p>乗車数でgroupbyして分布を見てみる（printは性能評価に含めないので省略）．
乗車数0人のデータがあることが分かるので，削除する．</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 一人以上乗車している</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@timer</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>check_passenger_c</span>(df):
</span></span><span style=display:flex><span>df_ <span style=color:#f92672>=</span> df<span style=color:#f92672>.</span>groupby(<span style=color:#e6db74>&#34;passenger_count&#34;</span>)<span style=color:#f92672>.</span>size()
</span></span><span style=display:flex><span>evaluate(df_)
</span></span><span style=display:flex><span>df <span style=color:#f92672>=</span> df[df[<span style=color:#e6db74>&#34;passenger_count&#34;</span>] <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>evaluate(df)
</span></span><span style=display:flex><span><span style=color:#66d9ef>return</span> df
</span></span></code></pre></div><p>乗車日時の日付データから，年，月，日，時の情報を取り出し，列を追加する．
乗車年や月の分布を見てみると不適切な値が含まれているので，削除する．</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 乗車年/月が正しい</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@timer</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>check_pu_date</span>(df):
</span></span><span style=display:flex><span>df[<span style=color:#e6db74>&#39;year&#39;</span>] <span style=color:#f92672>=</span>  df[<span style=color:#e6db74>&#39;tpep_pickup_datetime&#39;</span>]<span style=color:#f92672>.</span>dt<span style=color:#f92672>.</span>year
</span></span><span style=display:flex><span>df[<span style=color:#e6db74>&#39;month&#39;</span>] <span style=color:#f92672>=</span> df[<span style=color:#e6db74>&#39;tpep_pickup_datetime&#39;</span>]<span style=color:#f92672>.</span>dt<span style=color:#f92672>.</span>month
</span></span><span style=display:flex><span>df[<span style=color:#e6db74>&#39;date&#39;</span>] <span style=color:#f92672>=</span>  df[<span style=color:#e6db74>&#39;tpep_pickup_datetime&#39;</span>]<span style=color:#f92672>.</span>dt<span style=color:#f92672>.</span>day
</span></span><span style=display:flex><span>df[<span style=color:#e6db74>&#39;hour&#39;</span>] <span style=color:#f92672>=</span>  df[<span style=color:#e6db74>&#39;tpep_pickup_datetime&#39;</span>]<span style=color:#f92672>.</span>dt<span style=color:#f92672>.</span>hour
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>df_ <span style=color:#f92672>=</span> df<span style=color:#f92672>.</span>groupby(<span style=color:#e6db74>&#34;year&#34;</span>)<span style=color:#f92672>.</span>size()
</span></span><span style=display:flex><span>evaluate(df_)
</span></span><span style=display:flex><span>df <span style=color:#f92672>=</span> df[(df[<span style=color:#e6db74>&#39;year&#39;</span>] <span style=color:#f92672>==</span> <span style=color:#ae81ff>2022</span>) <span style=color:#f92672>|</span> (df[<span style=color:#e6db74>&#39;year&#39;</span>] <span style=color:#f92672>==</span> <span style=color:#ae81ff>2023</span>)]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>df_ <span style=color:#f92672>=</span> df<span style=color:#f92672>.</span>groupby(<span style=color:#e6db74>&#34;month&#34;</span>)<span style=color:#f92672>.</span>size()
</span></span><span style=display:flex><span>evaluate(df_)
</span></span><span style=display:flex><span>df <span style=color:#f92672>=</span> df[(df[<span style=color:#e6db74>&#39;month&#39;</span>] <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>&amp;</span> df[<span style=color:#e6db74>&#39;month&#39;</span>] <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>12</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>df_ <span style=color:#f92672>=</span> df<span style=color:#f92672>.</span>groupby([<span style=color:#e6db74>&#34;year&#34;</span>, <span style=color:#e6db74>&#34;month&#34;</span>])<span style=color:#f92672>.</span>size()
</span></span><span style=display:flex><span>evaluate(df_)
</span></span><span style=display:flex><span>evaluate(df)
</span></span><span style=display:flex><span><span style=color:#66d9ef>return</span> df
</span></span></code></pre></div><p>降車時間と乗車時間の差を分に変換して列を追加する．
非正の乗車時間や長すぎる乗車時間を削除する．</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 現実的な乗車時間（分）</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@timer</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>check_ride_time</span>(df):
</span></span><span style=display:flex><span>df[<span style=color:#e6db74>&#34;ride_time&#34;</span>] <span style=color:#f92672>=</span> (df[<span style=color:#e6db74>&#34;tpep_dropoff_datetime&#34;</span>] <span style=color:#f92672>-</span> df[<span style=color:#e6db74>&#34;tpep_pickup_datetime&#34;</span>])<span style=color:#f92672>.</span>dt<span style=color:#f92672>.</span>seconds <span style=color:#f92672>/</span> <span style=color:#ae81ff>60</span>
</span></span><span style=display:flex><span>df <span style=color:#f92672>=</span> df[(df[<span style=color:#e6db74>&#34;ride_time&#34;</span>] <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) <span style=color:#f92672>&amp;</span> (df[<span style=color:#e6db74>&#34;ride_time&#34;</span>] <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>180</span>)]
</span></span><span style=display:flex><span>evaluate(df)
</span></span><span style=display:flex><span><span style=color:#66d9ef>return</span> df
</span></span></code></pre></div><p>乗車距離や運賃についても非負や大きすぎる値を削除する．</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># 現実的な距離</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@timer</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>check_trip_distance</span>(df):
</span></span><span style=display:flex><span>df <span style=color:#f92672>=</span> df[(df[<span style=color:#e6db74>&#34;trip_distance&#34;</span>] <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) <span style=color:#f92672>&amp;</span> (df[<span style=color:#e6db74>&#34;trip_distance&#34;</span>] <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>250</span>)]
</span></span><span style=display:flex><span>evaluate(df)
</span></span><span style=display:flex><span><span style=color:#66d9ef>return</span> df
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 現実的な運賃</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@timer</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>check_total_amount</span>(df):
</span></span><span style=display:flex><span>df <span style=color:#f92672>=</span> df[(df[<span style=color:#e6db74>&#34;total_amount&#34;</span>] <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) <span style=color:#f92672>&amp;</span> (df[<span style=color:#e6db74>&#34;total_amount&#34;</span>] <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>1000</span>)]
</span></span><span style=display:flex><span>evaluate(df)
</span></span><span style=display:flex><span><span style=color:#66d9ef>return</span> df
</span></span></code></pre></div><p>乗降車地点のIDから緯度経度を算出する．
IDと地点の関係は以下で確認することができる．</p><blockquote><p><a href=https://d37ci6vzurychx.cloudfront.net/misc/taxi+_zone_lookup.csv>https://d37ci6vzurychx.cloudfront.net/misc/taxi+_zone_lookup.csv</a></p></blockquote><p>緯度経度は，</p><blockquote><p><a href=https://d37ci6vzurychx.cloudfront.net/misc/taxi_zones.zip>https://d37ci6vzurychx.cloudfront.net/misc/taxi_zones.zip</a></p></blockquote><p>をもとに作成した変換テーブルをmergeすることで列を追加する．</p><p>緯度経度の情報からニューヨーク市外のデータを削除する．</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># IDから緯度経度を割り出す</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@timer</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>add_coordinate</span>(df, ID_df):
</span></span><span style=display:flex><span>df <span style=color:#f92672>=</span> df<span style=color:#f92672>.</span>merge(ID_df<span style=color:#f92672>.</span>rename(columns<span style=color:#f92672>=</span>{<span style=color:#e6db74>&#34;longitude&#34;</span>: <span style=color:#e6db74>&#34;start_lon&#34;</span>, <span style=color:#e6db74>&#34;latitude&#34;</span>: <span style=color:#e6db74>&#34;start_lat&#34;</span>}),
</span></span><span style=display:flex><span>left_on<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;PULocationID&#34;</span>, right_on<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;LocationID&#34;</span>, how<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;left&#34;</span>)<span style=color:#f92672>.</span>drop(<span style=color:#e6db74>&#34;LocationID&#34;</span>, axis<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>df <span style=color:#f92672>=</span> df<span style=color:#f92672>.</span>merge(ID_df<span style=color:#f92672>.</span>rename(columns<span style=color:#f92672>=</span>{<span style=color:#e6db74>&#34;longitude&#34;</span>: <span style=color:#e6db74>&#34;end_lon&#34;</span>, <span style=color:#e6db74>&#34;latitude&#34;</span>: <span style=color:#e6db74>&#34;end_lat&#34;</span>}),
</span></span><span style=display:flex><span>left_on<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;DOLocationID&#34;</span>, right_on<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;LocationID&#34;</span>, how<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;left&#34;</span>)<span style=color:#f92672>.</span>drop(<span style=color:#e6db74>&#34;LocationID&#34;</span>, axis<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>evaluate(df)
</span></span><span style=display:flex><span><span style=color:#66d9ef>return</span> df
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># NY内かをcheckする</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@timer</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>in_NY</span>(df):
</span></span><span style=display:flex><span>df <span style=color:#f92672>=</span> df[(df[<span style=color:#e6db74>&#34;start_lon&#34;</span>] <span style=color:#f92672>&lt;=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>71.47</span>) <span style=color:#f92672>&amp;</span> (df[<span style=color:#e6db74>&#34;start_lon&#34;</span>] <span style=color:#f92672>&gt;=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>79.45</span>)]
</span></span><span style=display:flex><span>df <span style=color:#f92672>=</span> df[(df[<span style=color:#e6db74>&#34;start_lat&#34;</span>] <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>40.29</span>) <span style=color:#f92672>&amp;</span> (df[<span style=color:#e6db74>&#34;start_lat&#34;</span>] <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>45</span>)]
</span></span><span style=display:flex><span>df <span style=color:#f92672>=</span> df[(df[<span style=color:#e6db74>&#34;end_lon&#34;</span>] <span style=color:#f92672>&lt;=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>71.47</span>) <span style=color:#f92672>&amp;</span> (df[<span style=color:#e6db74>&#34;end_lon&#34;</span>] <span style=color:#f92672>&gt;=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>79.45</span>)]
</span></span><span style=display:flex><span>df <span style=color:#f92672>=</span> df[(df[<span style=color:#e6db74>&#34;end_lat&#34;</span>] <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>40.29</span>) <span style=color:#f92672>&amp;</span> (df[<span style=color:#e6db74>&#34;end_lat&#34;</span>] <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>45</span>)]
</span></span><span style=display:flex><span>evaluate(df)
</span></span><span style=display:flex><span><span style=color:#66d9ef>return</span> df
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>check_in_NY</span>(df, ID_df):
</span></span><span style=display:flex><span>df <span style=color:#f92672>=</span> add_coordinate(df, ID_df)
</span></span><span style=display:flex><span>df <span style=color:#f92672>=</span> in_NY(df)
</span></span><span style=display:flex><span><span style=color:#66d9ef>return</span> df
</span></span></code></pre></div><p>以上のようにデータを読み込み，型変換，列追加，異常値削除をする一連の処理を用意した．</p><ol><li>ファイルの読み込み</li><li>日付データを文字列から日付型に変換</li><li>前処理</li><li>欠損値を削除</li><li>乗客数のチェック</li><li>groupbyで分布を確認</li><li>1人以上を選択</li><li>乗車時刻をチェック</li><li>日付データから年月日時を取得し，列を追加</li><li>年でgroupbyして，確認 → 該当年のみを選択</li><li>月でgroupbyして，確認 → 1～12月のみを選択</li><li>年，月でgroupbyして分布を確認</li><li>乗車時間をcheck</li><li>降車時刻と乗車時刻の差をとり，分に変換して列を追加（<code>dt.total_second</code>がFireDucks未対応）</li><li>現実的な乗車時間のデータを選択する</li><li>乗車距離をチェック</li><li>現実的な乗車距離のデータを選択する</li><li>料金をチェック</li><li>現実的な料金のデータを選択する</li><li>NY市内のデータを選択</li><li>乗降車のIDと，緯度経度のテーブルをマージする</li><li>乗降車の緯度経度がNY市内となっているデータを選択</li></ol><h2 id=pandasでの実行時間>pandasでの実行時間</h2><p>まずはpandasでの実行時間を確認してみる．
測定には24コアXeonサーバー（Intel(R) Xeon(R) Gold 6226 CPU x 2，メインメモリ256GB）を用いた．</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span>data_path <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;data_sets&#34;</span>
</span></span><span style=display:flex><span>fn <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(data_path, <span style=color:#e6db74>&#34;taxi_all.csv&#34;</span>)
</span></span><span style=display:flex><span>ID_file <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(data_path, <span style=color:#e6db74>&#34;ID_to_coordinate.csv&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>need_cols <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;tpep_pickup_datetime&#39;</span>,<span style=color:#e6db74>&#39;tpep_dropoff_datetime&#39;</span>, <span style=color:#e6db74>&#39;passenger_count&#39;</span>, <span style=color:#e6db74>&#39;trip_distance&#39;</span>,
</span></span><span style=display:flex><span><span style=color:#e6db74>&#39;PULocationID&#39;</span>, <span style=color:#e6db74>&#39;DOLocationID&#39;</span>, <span style=color:#e6db74>&#39;total_amount&#39;</span>, <span style=color:#e6db74>&#39;improvement_surcharge&#39;</span>, <span style=color:#e6db74>&#39;extra&#39;</span>, <span style=color:#e6db74>&#39;fare_amount&#39;</span>, <span style=color:#e6db74>&#39;RatecodeID&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>@timer</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>Preprocessing</span>():
</span></span><span style=display:flex><span>df <span style=color:#f92672>=</span> file_read(fn, {<span style=color:#e6db74>&#34;usecols&#34;</span>: need_cols})
</span></span><span style=display:flex><span>ID_df <span style=color:#f92672>=</span> file_read(ID_file)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>df <span style=color:#f92672>=</span> txt_to_date(df, <span style=color:#e6db74>&#34;tpep_pickup_datetime&#34;</span>)
</span></span><span style=display:flex><span>df <span style=color:#f92672>=</span> txt_to_date(df, <span style=color:#e6db74>&#34;tpep_dropoff_datetime&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>df <span style=color:#f92672>=</span> drop_na(df)
</span></span><span style=display:flex><span>df <span style=color:#f92672>=</span> check_passenger_c(df)
</span></span><span style=display:flex><span>df <span style=color:#f92672>=</span> check_pu_date(df)
</span></span><span style=display:flex><span>df <span style=color:#f92672>=</span> check_ride_time(df)
</span></span><span style=display:flex><span>df <span style=color:#f92672>=</span> check_trip_distance(df)
</span></span><span style=display:flex><span>df <span style=color:#f92672>=</span> check_total_amount(df)
</span></span><span style=display:flex><span>df <span style=color:#f92672>=</span> check_in_NY(df, ID_df)
</span></span><span style=display:flex><span>evaluate(df)
</span></span><span style=display:flex><span><span style=color:#66d9ef>return</span> df
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>df <span style=color:#f92672>=</span> Preprocessing()
</span></span></code></pre></div><p>さて，pandasでの実行時間は下表のような結果になった．
<code>file_read</code>が2件あるのはtaxiのデータの他に，マージ用の地点データも読み込んだためであり，<code>txt_to_date</code>は乗車時間と降車時間の2件を変換したためである．
実行時間を見てみるとファイル読み込みに1分以上かかっていることが分かる．
さらに列の追加やmerge処理を含む<code>check_pu_date</code>や<code>add_coordinate</code>に30秒以上時間がかかっており，実装した前処理の実行時間は終了するまでに186秒かかっている．</p><h2 id=fireducksでの実行時間>FireDucksでの実行時間</h2><p>importするライブラリをpandasに置き換えてFireDucksを用いた場合の実行時間の計測を行う．</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>pip install fireducks
</span></span></code></pre></div><p>pandasの前処理計算のために記述した上記スクリプトはFireDucksがpandasとの互換性を持っているためにFireDucksをimportすれば，そのまま利用可能である．</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> fireducks.pandas <span style=color:#66d9ef>as</span> pd
</span></span></code></pre></div><p>注意点として，FireDucksはメソッドが呼ばれても処理をすぐには実行せず，結果が必要になった際にまとめて処理を実行する．
そのため，各メソッドの実行時間を計測するためには<code>_evaliate()</code>を実行する必要がある．</p><p>FireDucksをimportし，同様の前処理計算を実行するとpandasとの実行時間との比較の表は以下のようになった．</p><table><thead><tr><th style=text-align:left>関数</th><th style=text-align:right>pandas[sec]</th><th style=text-align:right>FireDucks[sec]</th><th style=text-align:right>速度向上率</th></tr></thead><tbody><tr><td style=text-align:left><code>file_read</code></td><td style=text-align:right>72.19</td><td style=text-align:right>3.52</td><td style=text-align:right>20.49</td></tr><tr><td style=text-align:left><code>file_read</code></td><td style=text-align:right>0.003</td><td style=text-align:right>0.01</td><td style=text-align:right>0.38</td></tr><tr><td style=text-align:left><code>txt_to_date</code></td><td style=text-align:right>9.07</td><td style=text-align:right>19.10</td><td style=text-align:right>0.48</td></tr><tr><td style=text-align:left><code>txt_to_date</code></td><td style=text-align:right>8.57</td><td style=text-align:right>20.57</td><td style=text-align:right>0.42</td></tr><tr><td style=text-align:left><code>drop_na</code></td><td style=text-align:right>3.13</td><td style=text-align:right>0.70</td><td style=text-align:right>4.47</td></tr><tr><td style=text-align:left><code>check_passenger_c</code></td><td style=text-align:right>3.21</td><td style=text-align:right>1.80</td><td style=text-align:right>1.79</td></tr><tr><td style=text-align:left><code>check_pu_date</code></td><td style=text-align:right>27.37</td><td style=text-align:right>0.99</td><td style=text-align:right>27.64</td></tr><tr><td style=text-align:left><code>check_ride_time</code></td><td style=text-align:right>7.02</td><td style=text-align:right>2.00</td><td style=text-align:right>3.51</td></tr><tr><td style=text-align:left><code>check_trip_distance</code></td><td style=text-align:right>3.24</td><td style=text-align:right>0.91</td><td style=text-align:right>3.55</td></tr><tr><td style=text-align:left><code>check_total_amount</code></td><td style=text-align:right>3.11</td><td style=text-align:right>0.93</td><td style=text-align:right>3.59</td></tr><tr><td style=text-align:left><code>add_coordinate</code></td><td style=text-align:right>28.32</td><td style=text-align:right>1.67</td><td style=text-align:right>16.97</td></tr><tr><td style=text-align:left><code>in_NY</code></td><td style=text-align:right>20.75</td><td style=text-align:right>2.71</td><td style=text-align:right>7.65</td></tr><tr><td style=text-align:left><code>Preprocessing</code></td><td style=text-align:right>186.02</td><td style=text-align:right>54.92</td><td style=text-align:right>3.39</td></tr></tbody></table><p><code>file_read</code>についてpandasでは終了まで70秒以上かかっていたが約3.5秒となり20倍以上高速化ができていることが確認できた．
またその他の時間がかかっていた処理（<code>check_pu_date</code>，<code>add_coordinate</code>）についても大幅な時間短縮ができている．</p><p><code>txt_to_date</code>についてはFireDucksを用いることで計算時間が増えている．
これは記事執筆時点において<code>to_datetime()</code>関数はFireDucksによる高速化対応がされていないためである．
しかし，<code>to_datetime()</code>のように高速化未対応な関数を呼ばれたときであってもFireDucksはpandasの関数を呼び出すことで計算を行うためエラーを返すことはない．</p><p>本記事の前処理計算においてトータルの計算時間はpandasが186秒であったのに対し，FireDucksでは55秒で約3.4倍の実行速度であった．
さらにこの55秒のうち40秒程は高速化未対応の処理に要する時間であり，今後更なる高速化が見込まれる．</p><ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5"><li><a href=/ja/posts/ttdc/ aria-label="前へ - 導入事例：トヨタテクニカルディベロップメント株式会社様 「Spicy MINT」" class="btn btn-primary"><span class=me-1>←</span>前へ</a></li><li><a href=/ja/posts/importhook/ aria-label="次へ - インポートフック：ソースコードを書き換えずに FireDucks を使う方法のご紹介" class="btn btn-primary">次へ<span class=ms-1>→</span></a></li></ul></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title="Post issues on GitHub issues" aria-label="Post issues on GitHub issues"><a target=_blank rel=noopener href=https://github.com/fireducks-dev/fireducks aria-label="Post issues on GitHub issues"><i class="fa-brands fa-github"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="Send an e-mail to us" aria-label="Send an e-mail to us"><a target=_blank rel=noopener href=mailto:contact@fireducks.jp.nec.com aria-label="Send an e-mail to us"><i class="fa-solid fa-envelope"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="Follow us in X" aria-label="Follow us in X"><a target=_blank rel=noopener href=https://x.com/fireducksdev aria-label="Follow us in X"><i class="fa-brands fa-x-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="Join us on Slack" aria-label="Join us on Slack"><a target=_blank rel=noopener href=https://join.slack.com/t/fireducks/shared_invite/zt-2j4lucmtj-IGR7AWlXO62Lu605pnBJ2w aria-label="Join us on Slack"><i class="fa-brands fa-slack"></i></a></li></ul></div><div class="col-6 col-sm-4 text-end text-xs-center order-sm-3"></div><div class="td-footer__copyright-etc col-12 col-sm-4 text-center py-2 order-sm-2"><span>&copy; 2024 FireDucks Dev Team All Rights Reserved</span></div></div></div></footer></div><script src=/js/main.min.350b703200e2632331b6ab5a6c71195d176b52e89c9b70db7c43764d40b28d92.js integrity="sha256-NQtwMgDiYyMxtqtabHEZXRdrUuicm3DbfEN2TUCyjZI=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.f724d3de49218995223b7316aa2e53e2b34bf42026bf399ebb21bb02212402d1.js integrity="sha256-9yTT3kkhiZUiO3MWqi5T4rNL9CAmvzmeuyG7AiEkAtE=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>