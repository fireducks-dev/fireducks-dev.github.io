<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=ja class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Notebook の %%time で FireDucks の時間計測をするときの落とし穴 | FireDucks</title>
<meta name=description content="Jupyter などの IPython Notebook で提供されているマジックコマンド `%%time` で FireDucks による処理の時間計測をする場合の落とし穴についてご紹介します"><meta property="og:title" content="Notebook の %%time で FireDucks の時間計測をするときの落とし穴"><meta property="og:description" content="Jupyter などの IPython Notebook で提供されているマジックコマンド `%%time` で FireDucks による処理の時間計測をする場合の落とし穴についてご紹介します"><meta property="og:type" content="article"><meta property="og:url" content="https://fireducks-dev.github.io/ja/posts/2024-12-26-time-pitfalls/"><meta property="og:image" content="https://fireducks-dev.github.io/images/fireducks_1200x630.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-12-26T09:35:10+09:00"><meta property="article:modified_time" content="2024-12-26T09:35:10+09:00"><meta itemprop=name content="Notebook の %%time で FireDucks の時間計測をするときの落とし穴"><meta itemprop=description content="Jupyter などの IPython Notebook で提供されているマジックコマンド `%%time` で FireDucks による処理の時間計測をする場合の落とし穴についてご紹介します"><meta itemprop=datePublished content="2024-12-26T09:35:10+09:00"><meta itemprop=dateModified content="2024-12-26T09:35:10+09:00"><meta itemprop=wordCount content="437"><meta itemprop=image content="https://fireducks-dev.github.io/images/fireducks_1200x630.png"><meta itemprop=keywords content><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://fireducks-dev.github.io/images/fireducks_1200x630.png"><meta name=twitter:title content="Notebook の %%time で FireDucks の時間計測をするときの落とし穴"><meta name=twitter:description content="Jupyter などの IPython Notebook で提供されているマジックコマンド `%%time` で FireDucks による処理の時間計測をする場合の落とし穴についてご紹介します"><link rel=preload href=/scss/main.min.2404b01c5fb65f0b4d76f0c632723d405f2faf20557f5aeff94d8efb2e91ec8b.css as=style><link href=/scss/main.min.2404b01c5fb65f0b4d76f0c632723d405f2faf20557f5aeff94d8efb2e91ec8b.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.3.min.js integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ==" crossorigin=anonymous></script></head><body class="td-page td-blog"><header><nav class="td-navbar navbar-dark js-navbar-scroll"><div class="container-fluid flex-column flex-md-row"><a class=navbar-brand href=/ja/><span class="navbar-brand__logo navbar-logo"></span><span class=navbar-brand__name>FireDucks</span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/ja/docs/get-started><span>Get Started</span></a></li><li class=nav-item><a class=nav-link href=/ja/docs/user-guide/01-intro/><span>Docs</span></a></li><li class=nav-item><a class=nav-link href=/ja/posts><span>Blogs</span></a></li><li class=nav-item><a class=nav-link href=/ja/docs/benchmarks><span>Benchmarks</span></a></li><li class=nav-item><a class=nav-link href=/ja/talks><span>Talks</span></a></li><li class=nav-item><a class=nav-link href=https://github.com/fireducks-dev/fireducks/issues target=_blank rel=noopener><span>Report Issue</span></a></li><li class=nav-item><a class=nav-link href=/ja/docs/about-us><span>About Us</span></a></li><li class="nav-item dropdown d-none d-lg-block"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>Japanese</a><ul class=dropdown-menu><li><a class=dropdown-item href=/posts/2024-12-26-time-pitfalls/>English</a></li></ul></div></li></ul></div><div class="d-none d-lg-block"></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ms-3 fas fa-bars" type=button data-bs-toggle=collapse data-bs-target=#td-section-nav aria-controls=td-section-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="td-sidebar-nav collapse" id=td-section-nav><div class="td-sidebar-nav__section nav-item dropdown d-block d-lg-none"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>Japanese</a><ul class=dropdown-menu><li><a class=dropdown-item href=/posts/2024-12-26-time-pitfalls/>English</a></li></ul></div></div><ul class="td-sidebar-nav__section pe-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-japosts-li><a href=/ja/posts/ class="align-left ps-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-japosts><span>Posts</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-japosts2024-12-26-time-pitfalls-li><a href=/ja/posts/2024-12-26-time-pitfalls/ class="align-left ps-0 active td-sidebar-link td-sidebar-link__page" id=m-japosts2024-12-26-time-pitfalls><span class=td-sidebar-nav-active-item>Notebook の %%time で FireDucks の時間計測をするときの落とし穴</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japosts2024-12-20-trace-li><a href=/ja/posts/2024-12-20-trace/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-japosts2024-12-20-trace><span>FireDucksのトレースのとりかた</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japosts2024-12-19-araki-li><a href=/ja/posts/2024-12-19-araki/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-japosts2024-12-19-araki><span>GPU版開発におけるpandasとの互換性確保</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japostsbeginner_guide-li><a href=/ja/posts/beginner_guide/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-japostsbeginner_guide><span>FireDucksが遅いと思ったら</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japosts2024-05-27-note10-li><a href=https://note.com/fireducks/n/n9d169e9054ed target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-japosts2024-05-27-note10><i class="fa fa-external-link"></i><span>pandasを用いた大規模データの前処理をfireducksに置き換えてみる</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japosts2024-05-20-note09-li><a href=https://note.com/fireducks/n/necfbb2dfdb84 target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-japosts2024-05-20-note09><i class="fa fa-external-link"></i><span>生成AIとデータフレーム高速化技術を組み合わせたら、データ分析が爆楽になった話</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japosts2024-05-13-note08-li><a href=https://note.com/fireducks/n/n4dd370647766 target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-japosts2024-05-13-note08><i class="fa fa-external-link"></i><span>Pandasを高速化方法比較</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japosts2024-05-08-note07-li><a href=https://note.com/fireducks/n/na95cf890f13b target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-japosts2024-05-08-note07><i class="fa fa-external-link"></i><span>どれくらいスピードアップしたのか</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japosts2024-04-22-note06-li><a href=https://note.com/fireducks/n/nd79ee805d99a target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-japosts2024-04-22-note06><i class="fa fa-external-link"></i><span>FireDucks と Polarsを比較してみた</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japosts2024-04-15-note05-li><a href=https://note.com/fireducks/n/na7484ce210f0 target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-japosts2024-04-15-note05><i class="fa fa-external-link"></i><span>FireDucks性能評価</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japosts2024-04-09-note04-li><a href=https://note.com/fireducks/n/n604974763502 target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-japosts2024-04-09-note04><i class="fa fa-external-link"></i><span>pandasの代替案: Fireducks,Vaex, Polars, Modinを徹底比較！どれが最適？</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japosts2024-04-01-note03-li><a href=https://note.com/fireducks/n/na5fde86c0ba3 target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-japosts2024-04-01-note03><i class="fa fa-external-link"></i><span>AWS GlueでFireDucksを使ってPandasを高速化する</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japosts2024-03-22-note02-li><a href=https://note.com/fireducks/n/nb5cabbe9236e target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-japosts2024-03-22-note02><i class="fa fa-external-link"></i><span>FireDucks入門: 学習コストゼロでpandasを超えるパフォーマンスを手に入れる!</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japosts2024-03-15-note-li><a href=https://note.com/fireducks/n/nee73e753df26 target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-japosts2024-03-15-note><i class="fa fa-external-link"></i><span>pandas高速化の新星、FireDucksに迫る</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japosts2023-12-24-ishizaka-li><a href=https://qiita.com/iszk1215/items/4916799360bfafd57bc4 target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-japosts2023-12-24-ishizaka><i class="fa fa-external-link"></i><span>FireDucks vs Polars 42勝24敗！ あなたはどっちを使ってpandasを高速化する！？</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japosts2023-12-20-daido-li><a href=https://qiita.com/shu_ohm1/items/33642646f5c055066cfe target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-japosts2023-12-20-daido><i class="fa fa-external-link"></i><span>FireDucks に隠し機能を作ろうと思ったけどボツになった話</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japosts2023-12-18-araki-li><a href=https://qiita.com/takuya-araki/items/38c3554ba72c9eb274ba target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-japosts2023-12-18-araki><i class="fa fa-external-link"></i><span>FireDucksにおける最適化処理の紹介</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japosts2023-12-15-ishizaka-li><a href=https://qiita.com/iszk1215/items/2c6385fa575de378a619 target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-japosts2023-12-15-ishizaka><i class="fa fa-external-link"></i><span>FireDucksを支える技術</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japosts2023-12-08-ohno-li><a href=https://qiita.com/ysyk-ohno/items/ddaaeca630d741a78f14 target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-japosts2023-12-08-ohno><i class="fa fa-external-link"></i><span>FireDucks の GroupBy アルゴリズム切替えについての解説</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japostsest-li><a href=/ja/posts/est/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-japostsest><span>FireDucks内部で働く高速化技術</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japosts2023-12-04-ishizaka-li><a href=https://qiita.com/iszk1215/items/abe7621d9f6754de690a target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-japosts2023-12-04-ishizaka><i class="fa fa-external-link"></i><span>FireDucksのご紹介</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japosts2023-12-01-daido-li><a href=https://qiita.com/shu_ohm1/items/b0a35cfb4fce5b71c715 target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-japosts2023-12-01-daido><i class="fa fa-external-link"></i><span>FireDucks のインポートフック機能にまつわるエトセトラ</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japostsimporthook-li><a href=/ja/posts/importhook/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-japostsimporthook><span>インポートフック：ソースコードを書き換えずに FireDucks を使う方法のご紹介</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japostsnes_taxi-li><a href=/ja/posts/nes_taxi/ class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-japostsnes_taxi><span>Pythonの高速データフレームライブラリFireDucksを使ってみた</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-japoststtdc-li><a href=https://jpn.nec.com/rd/technologies/202312/index.html target=_blank rel=noopener class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id=m-japoststtdc><i class="fa fa-external-link"></i><span>導入事例：トヨタテクニカルディベロップメント株式会社様 「Spicy MINT」</span></a></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ms-2 pb-1 pt-2 mb-0"></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#まずは結論>まずは結論</a></li><li><a href=#notebook-における時間計測>Notebook における時間計測</a><ul><li><a href=#fireducks-の時間計測>FireDucks の時間計測</a></li><li><a href=#誤った時間計測の例>誤った時間計測の例</a></li><li><a href=#正しい時間計測の例>正しい時間計測の例</a></li><li><a href=#別解>別解？</a></li></ul></li><li><a href=#まとめにかえて>まとめにかえて</a></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 ps-md-5 pe-md-4" role=main><a class=td-rss-button title=RSS href=https://fireducks-dev.github.io/ja/posts/index.xml target=_blank rel=noopener><i class="fa-solid fa-rss" aria-hidden=true></i></a><div class=td-content><h1>Notebook の %%time で FireDucks の時間計測をするときの落とし穴</h1><div class=lead>Jupyter などの IPython Notebook で提供されているマジックコマンド <code>%%time</code> で FireDucks による処理の時間計測をする場合の落とし穴についてご紹介します</div><div class="td-byline mb-4">By <b>Osamu Daido</b> |
<time datetime=2024-12-26 class=text-muted>Thursday, December 26, 2024</time></div><header class=article-meta></header><p>FireDucks 開発チームの大道です．今回の開発者ブログでは時間計測のちょっとした落とし穴についてご紹介したいと思います．</p><h2 id=まずは結論>まずは結論</h2><p>IPython Notebook で提供されている <code>%%time</code> マジックコマンドで FireDucks の時間計測をするときも，必ず <code>_evaluate()</code> メソッドを呼んで確実に評価が行われるようにしましょう！</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>%%</span>time
</span></span><span style=display:flex><span>df <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>read_csv(<span style=color:#e6db74>&#34;input.csv&#34;</span>)
</span></span><span style=display:flex><span>df<span style=color:#f92672>.</span>_evaluate()
</span></span></code></pre></div><h2 id=notebook-における時間計測>Notebook における時間計測</h2><p>Jupyter などの IPython Notebook では，コードを書いたセルの実行時間を測定するために <code>%%time</code> というマジックコマンドが提供されています．ちなみにパーセント記号ひとつの <code>%time</code> だとその行だけの実行時間の計測で，パーセント記号ふたつの <code>%%time</code> だとセルの実行時間の計測です．FireDucks は pandas と同じ API で pandas よりも高速に処理できることが特徴ですので，処理時間を計測してみた方や計測してみたいと思った方もいらっしゃるでしょう．</p><p>しかし…，おや？ 以下の処理時間計測は正しいのでしょうか？</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> fireducks.pandas <span style=color:#66d9ef>as</span> pd
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>%%</span>time
</span></span><span style=display:flex><span>df <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>read_csv(<span style=color:#e6db74>&#34;sample-dataset-tips.csv&#34;</span>)
</span></span><span style=display:flex><span>df<span style=color:#f92672>.</span>head()
</span></span></code></pre></div><blockquote><pre><code>CPU times: user 3.37 ms, sys: 4.06 ms, total: 7.43 ms
Wall time: 6.87 ms
</code></pre><table><thead><tr><th style=text-align:right></th><th style=text-align:right>total_bill</th><th style=text-align:right>tip</th><th style=text-align:right>sex</th><th style=text-align:right>smoker</th><th style=text-align:right>day</th><th style=text-align:right>time</th><th style=text-align:right>size</th></tr></thead><tbody><tr><td style=text-align:right>0</td><td style=text-align:right>16.99</td><td style=text-align:right>1.01</td><td style=text-align:right>Female</td><td style=text-align:right>No</td><td style=text-align:right>Sun</td><td style=text-align:right>Dinner</td><td style=text-align:right>2</td></tr><tr><td style=text-align:right>1</td><td style=text-align:right>10.34</td><td style=text-align:right>1.66</td><td style=text-align:right>Male</td><td style=text-align:right>No</td><td style=text-align:right>Sun</td><td style=text-align:right>Dinner</td><td style=text-align:right>3</td></tr><tr><td style=text-align:right>2</td><td style=text-align:right>21.01</td><td style=text-align:right>3.50</td><td style=text-align:right>Male</td><td style=text-align:right>No</td><td style=text-align:right>Sun</td><td style=text-align:right>Dinner</td><td style=text-align:right>3</td></tr><tr><td style=text-align:right>3</td><td style=text-align:right>23.68</td><td style=text-align:right>3.31</td><td style=text-align:right>Male</td><td style=text-align:right>No</td><td style=text-align:right>Sun</td><td style=text-align:right>Dinner</td><td style=text-align:right>2</td></tr><tr><td style=text-align:right>4</td><td style=text-align:right>24.59</td><td style=text-align:right>3.61</td><td style=text-align:right>Female</td><td style=text-align:right>No</td><td style=text-align:right>Sun</td><td style=text-align:right>Dinner</td><td style=text-align:right>4</td></tr></tbody></table></blockquote><h3 id=fireducks-の時間計測>FireDucks の時間計測</h3><p><a href=/ja/docs/user-guide/02-exec-model/>実行モデルの解説ページ</a>に記載している通り，FireDucks は遅延実行モデルを採用しています．簡単に言うと FireDucks のデータフレームは，例えば <code>print()</code> や <code>display()</code> で画面に表示させたり，データフレームの <code>_evaluate()</code> メソッドを明示的に呼んだりするまでは，実際の処理が始まらずに溜め込まれた状態のままになるのです．FireDucks は溜め込んでいた処理を実行する前に最適化を行うことでより高速に処理できるようになっており，溜め込んでいた処理を実際に実行することを「評価」と呼びます．</p><p>ところで，IPython Notebook ではセルの最後に代入文ではなく値が置かれていると，Python インタープリターの REPL と同様に，値が自動で画面に出力されます．つまり IPython 的に言うと自動的に <code>display()</code> が呼ばれているということであるため，FireDucks のデータフレームはセルの最後に置いておけば自動で評価もされるということになります．</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>df <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>read_csv(<span style=color:#e6db74>&#34;sample-dataset-tips.csv&#34;</span>)
</span></span><span style=display:flex><span>df <span style=color:#f92672>=</span> df<span style=color:#f92672>.</span>sort_values(by<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;tip&#34;</span>)
</span></span><span style=display:flex><span>df  <span style=color:#75715e># ← これ</span>
</span></span></code></pre></div><p>しかし，マジックコマンド <code>%%time</code> で処理時間を計測したい場合にはちょっとした落とし穴がありました．FireDucks データフレームをセルの最後に置いておけば自動で評価されるということと，それで正しい時間が計測できているかということは別の問題だったのです．</p><h3 id=誤った時間計測の例>誤った時間計測の例</h3><p>10GB 弱の csv ファイルを用意して実験してみました．以下のようなセルを実行すると奇妙なことが起こります．</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>%%</span>time
</span></span><span style=display:flex><span>df <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>read_csv(<span style=color:#e6db74>&#34;sample-dataset-tips10gb.csv&#34;</span>)
</span></span><span style=display:flex><span>df <span style=color:#f92672>=</span> df<span style=color:#f92672>.</span>sort_values(by<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;tip&#34;</span>)
</span></span><span style=display:flex><span>df
</span></span></code></pre></div><blockquote><pre><code>CPU times: user 18.2 ms, sys: 4.31 ms, total: 22.5 ms
Wall time: 15.2 ms
</code></pre><table><thead><tr><th style=text-align:right></th><th style=text-align:right>total_bill</th><th style=text-align:right>tip</th><th style=text-align:right>sex</th><th style=text-align:right>smoker</th><th style=text-align:right>day</th><th style=text-align:right>time</th><th style=text-align:right>size</th></tr></thead><tbody><tr><td style=text-align:right>67</td><td style=text-align:right>3.07</td><td style=text-align:right>1.0</td><td style=text-align:right>Female</td><td style=text-align:right>Yes</td><td style=text-align:right>Sat</td><td style=text-align:right>Dinner</td><td style=text-align:right>1</td></tr><tr><td style=text-align:right>92</td><td style=text-align:right>5.75</td><td style=text-align:right>1.0</td><td style=text-align:right>Female</td><td style=text-align:right>Yes</td><td style=text-align:right>Fri</td><td style=text-align:right>Dinner</td><td style=text-align:right>2</td></tr><tr><td style=text-align:right>&mldr;</td><td style=text-align:right>&mldr;</td><td style=text-align:right>&mldr;</td><td style=text-align:right>&mldr;</td><td style=text-align:right>&mldr;</td><td style=text-align:right>&mldr;</td><td style=text-align:right>&mldr;</td><td style=text-align:right>&mldr;</td></tr><tr><td style=text-align:right>319815362</td><td style=text-align:right>50.81</td><td style=text-align:right>10.0</td><td style=text-align:right>Male</td><td style=text-align:right>Yes</td><td style=text-align:right>Sat</td><td style=text-align:right>Dinner</td><td style=text-align:right>3</td></tr><tr><td style=text-align:right>319815606</td><td style=text-align:right>50.81</td><td style=text-align:right>10.0</td><td style=text-align:right>Male</td><td style=text-align:right>Yes</td><td style=text-align:right>Sat</td><td style=text-align:right>Dinner</td><td style=text-align:right>3</td></tr></tbody></table><p>319815680 rows x 7 columns</p></blockquote><p>Wall time と書かれているところを見ましょう．3億行もあるデータを読み込んでソートするのに 15 ミリ秒しかかかっていないのだとしたらすごいことですね．実際にはそんなことはなく，このセルの実行を開始してから結果が表示されるまでに10秒ぐらい待たされました．結果が画面に出力されているのだから，きちんと評価されているはずでは…？ と思いましたが，それは半分正しく，半分間違っていました．</p><p>実はこの書き方の場合，<code>%%time</code> のタイマーが止まった後でデータフレームの評価が始まってしまっているのです．つまり，<strong>タイマー停止 → 評価 → 表示</strong> の順序になってしまっているため，データフレームの実際の処理が <code>%%time</code> の測定範囲外にあるということなのです．</p><h3 id=正しい時間計測の例>正しい時間計測の例</h3><p>というわけで，処理時間を計測したい場合は IPython Notebook でも明示的にデータフレームの <code>_evaluate()</code> メソッドを呼び出し，きちんと評価しましょう．以下のように書くと，<strong>評価 → タイマー停止 → 表示</strong> の順序で実行されるため，データフレームの実際の処理が <code>%%time</code> の測定範囲に入ります．</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>%%</span>time
</span></span><span style=display:flex><span>df <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>read_csv(<span style=color:#e6db74>&#34;sample-dataset-tips10gb.csv&#34;</span>)
</span></span><span style=display:flex><span>df <span style=color:#f92672>=</span> df<span style=color:#f92672>.</span>sort_values(by<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;tip&#34;</span>)
</span></span><span style=display:flex><span>df<span style=color:#f92672>.</span>_evaluate()
</span></span></code></pre></div><blockquote><pre><code>CPU times: user 3min 58s, sys: 1min 2s, total: 5min
Wall time: 11.1 s
</code></pre><table><thead><tr><th style=text-align:right></th><th style=text-align:right>total_bill</th><th style=text-align:right>tip</th><th style=text-align:right>sex</th><th style=text-align:right>smoker</th><th style=text-align:right>day</th><th style=text-align:right>time</th><th style=text-align:right>size</th></tr></thead><tbody><tr><td style=text-align:right>67</td><td style=text-align:right>3.07</td><td style=text-align:right>1.0</td><td style=text-align:right>Female</td><td style=text-align:right>Yes</td><td style=text-align:right>Sat</td><td style=text-align:right>Dinner</td><td style=text-align:right>1</td></tr><tr><td style=text-align:right>92</td><td style=text-align:right>5.75</td><td style=text-align:right>1.0</td><td style=text-align:right>Female</td><td style=text-align:right>Yes</td><td style=text-align:right>Fri</td><td style=text-align:right>Dinner</td><td style=text-align:right>2</td></tr><tr><td style=text-align:right>&mldr;</td><td style=text-align:right>&mldr;</td><td style=text-align:right>&mldr;</td><td style=text-align:right>&mldr;</td><td style=text-align:right>&mldr;</td><td style=text-align:right>&mldr;</td><td style=text-align:right>&mldr;</td><td style=text-align:right>&mldr;</td></tr><tr><td style=text-align:right>319815362</td><td style=text-align:right>50.81</td><td style=text-align:right>10.0</td><td style=text-align:right>Male</td><td style=text-align:right>Yes</td><td style=text-align:right>Sat</td><td style=text-align:right>Dinner</td><td style=text-align:right>3</td></tr><tr><td style=text-align:right>319815606</td><td style=text-align:right>50.81</td><td style=text-align:right>10.0</td><td style=text-align:right>Male</td><td style=text-align:right>Yes</td><td style=text-align:right>Sat</td><td style=text-align:right>Dinner</td><td style=text-align:right>3</td></tr></tbody></table><p>319815680 rows x 7 columns</p></blockquote><h3 id=別解>別解？</h3><p>ちなみに以下のように書くと，<strong>評価 → 表示 → タイマー停止</strong> の順序になります．この場合，データフレームを画面に表示するための処理も時間計測の範囲内に含まれることになるため，僅かではありますが時間計測の意味が変わってきます．データフレームの出力と計測結果の出力の順序も入れ替わっていますね．</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>%%</span>time
</span></span><span style=display:flex><span>df <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>read_csv(<span style=color:#e6db74>&#34;sample-dataset-tips10gb.csv&#34;</span>)
</span></span><span style=display:flex><span>df <span style=color:#f92672>=</span> df<span style=color:#f92672>.</span>sort_values(by<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;tip&#34;</span>)
</span></span><span style=display:flex><span>display(df)
</span></span></code></pre></div><blockquote><table><thead><tr><th style=text-align:right></th><th style=text-align:right>total_bill</th><th style=text-align:right>tip</th><th style=text-align:right>sex</th><th style=text-align:right>smoker</th><th style=text-align:right>day</th><th style=text-align:right>time</th><th style=text-align:right>size</th></tr></thead><tbody><tr><td style=text-align:right>67</td><td style=text-align:right>3.07</td><td style=text-align:right>1.0</td><td style=text-align:right>Female</td><td style=text-align:right>Yes</td><td style=text-align:right>Sat</td><td style=text-align:right>Dinner</td><td style=text-align:right>1</td></tr><tr><td style=text-align:right>92</td><td style=text-align:right>5.75</td><td style=text-align:right>1.0</td><td style=text-align:right>Female</td><td style=text-align:right>Yes</td><td style=text-align:right>Fri</td><td style=text-align:right>Dinner</td><td style=text-align:right>2</td></tr><tr><td style=text-align:right>&mldr;</td><td style=text-align:right>&mldr;</td><td style=text-align:right>&mldr;</td><td style=text-align:right>&mldr;</td><td style=text-align:right>&mldr;</td><td style=text-align:right>&mldr;</td><td style=text-align:right>&mldr;</td><td style=text-align:right>&mldr;</td></tr><tr><td style=text-align:right>319815362</td><td style=text-align:right>50.81</td><td style=text-align:right>10.0</td><td style=text-align:right>Male</td><td style=text-align:right>Yes</td><td style=text-align:right>Sat</td><td style=text-align:right>Dinner</td><td style=text-align:right>3</td></tr><tr><td style=text-align:right>319815606</td><td style=text-align:right>50.81</td><td style=text-align:right>10.0</td><td style=text-align:right>Male</td><td style=text-align:right>Yes</td><td style=text-align:right>Sat</td><td style=text-align:right>Dinner</td><td style=text-align:right>3</td></tr></tbody></table><p>319815680 rows x 7 columns</p><pre><code>CPU times: user 3min 58s, sys: 55.4 s, total: 4min 53s
Wall time: 10.6 s
</code></pre></blockquote><h2 id=まとめにかえて>まとめにかえて</h2><p>FireDucks は pandas と同じ API を維持しながら遅延評価の仕組みを取り入れているため，処理時間の計測においてはこのようなちょっとしたことにも気をつける必要があります．しかし pandas とほとんど同じコードのまま処理を高速化できる FireDucks は，データサイエンスの強い味方になってくれるでしょう．</p><p>最近は多くの方が FireDucks に興味を示してくださり，速くなったという声やバグレポートなども増えつつあります．私たち開発チームとしても，FireDucks を広く，末永く使っていただけるよう頑張っています！ 今後のアップデートにも是非ご注目ください．</p><p>May the Acceleration be with you, FireDucks 開発チーム</p><ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5"><li><a href=/ja/posts/2024-12-20-trace/ aria-label="前へ - FireDucksのトレースのとりかた" class="btn btn-primary"><span class=me-1>←</span>前へ</a></li><li><a class="btn btn-primary disabled">次へ<span class=ms-1>→</span></a></li></ul></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="col-6 col-sm-4 text-xs-center order-sm-2"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title="Post issues on GitHub issues" aria-label="Post issues on GitHub issues"><a target=_blank rel=noopener href=https://github.com/fireducks-dev/fireducks aria-label="Post issues on GitHub issues"><i class="fa-brands fa-github"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="Send an e-mail to us" aria-label="Send an e-mail to us"><a target=_blank rel=noopener href=mailto:contact@fireducks.jp.nec.com aria-label="Send an e-mail to us"><i class="fa-solid fa-envelope"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="Follow us in X" aria-label="Follow us in X"><a target=_blank rel=noopener href=https://x.com/fireducksdev aria-label="Follow us in X"><i class="fa-brands fa-x-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="Join us on Slack" aria-label="Join us on Slack"><a target=_blank rel=noopener href=https://join.slack.com/t/fireducks/shared_invite/zt-2j4lucmtj-IGR7AWlXO62Lu605pnBJ2w aria-label="Join us on Slack"><i class="fa-brands fa-slack"></i></a></li></ul></div><div class="col-6 col-sm-4 text-end text-xs-center order-sm-3"></div><div class="td-footer__copyright-etc col-12 col-sm-4 text-center py-2 order-sm-2"><span>&copy; 2024 FireDucks Dev Team All Rights Reserved</span></div></div></div></footer></div><script src=/js/main.min.350b703200e2632331b6ab5a6c71195d176b52e89c9b70db7c43764d40b28d92.js integrity="sha256-NQtwMgDiYyMxtqtabHEZXRdrUuicm3DbfEN2TUCyjZI=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.f724d3de49218995223b7316aa2e53e2b34bf42026bf399ebb21bb02212402d1.js integrity="sha256-9yTT3kkhiZUiO3MWqi5T4rNL9CAmvzmeuyG7AiEkAtE=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>